<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìú Chiusura Cassa</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#14283c">
  <link rel="manifest" href="./manifest.json">
  
  <link href="https://fonts.googleapis.com/css2?family=Pirata+One&family=Rye&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Georgia', serif;
      background: linear-gradient(rgba(20, 40, 60, 0.40), rgba(20, 40, 60, 0.40)), url('./assets/images/caffe.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh; padding: 20px;
    }
    .header {
      background: linear-gradient(145deg, #8b4513 0%, #654321 100%);
      color: #f4e4c1; padding: 20px; border-radius: 10px; margin-bottom: 20px;
      border: 3px solid #3d1f0f; display: flex; justify-content: space-between;
      align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .header h1 {
      font-family: 'Pirata One', cursive; font-size: 2em; text-shadow: 2px 2px 0 rgba(0,0,0,0.5);
    }
    .btn-home {
      background: linear-gradient(145deg, #e8b873 0%, #c89858 100%);
      color: #2c1810; padding: 12px 25px; border: 3px solid #3d1f0f;
      border-radius: 8px; cursor: pointer; font-weight: 700; font-family: 'Rye', cursive;
      box-shadow: 0 4px 0 #3d1f0f; text-decoration: none;
    }
    .container {
      max-width: 900px; margin: 0 auto;
      background: linear-gradient(145deg, #d4a574 0%, #a67c52 100%);
      padding: 30px; border-radius: 15px; border: 4px solid #6b4423;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
    }
    .info-box {
      background: rgba(139,69,19,0.3); padding: 20px; border-radius: 10px;
      margin-bottom: 25px; border: 2px solid #6b4423;
    }
    .info-box h2 { font-family: 'Pirata One'; color: #2c1810; margin-bottom: 10px; font-size: 1.8em; }
    .info-item { display: inline-block; margin-right: 30px; font-size: 1.1em; color: #2c1810; }
    .alert-box {
      background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 8px;
      margin-bottom: 20px; color: #856404; font-weight: 600;
    }
    .btn-precedente {
      background: linear-gradient(145deg, #e8b873 0%, #c89858 100%);
      color: #2c1810; padding: 12px 24px; border: 2px solid #6b4423;
      border-radius: 8px; cursor: pointer; font-weight: 700; font-family: 'Pirata One';
      margin-top: 10px; display: inline-block; font-size: 1.15em;
    }
    .btn-modifica {
      background: #ffc107; color: #2c1810; padding: 10px 20px; border: 2px solid #e0a800;
      border-radius: 8px; cursor: pointer; font-weight: 700; font-family: 'Rye';
      margin-left: 15px; font-size: 1em;
    }
    .section {
      background: rgba(244,228,193,0.5); padding: 20px; border-radius: 10px;
      margin-bottom: 20px; border: 2px dashed #6b4423;
    }
    .section-title {
      font-family: 'Rye'; font-size: 1.5em; color: #2c1810; margin-bottom: 15px;
      padding-bottom: 10px; border-bottom: 3px solid #8b4513;
    }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    .taglio-item {
      background: #f4e4c1; padding: 10px; border-radius: 8px;
      border: 2px solid #6b4423; display: flex; flex-direction: column; gap: 5px;
    }
    .taglio-label { font-weight: 700; color: #2c1810; font-size: 1.1em; }
    .taglio-input {
      width: 100%; padding: 8px; border: 2px solid #8b4513; border-radius: 5px;
      font-size: 1.1em; text-align: center; background: white;
    }
    .taglio-total { color: #654321; font-weight: 700; text-align: right; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 700; color: #2c1810; font-size: 1.1em; }
    .form-group input, .form-group textarea {
      width: 100%; padding: 12px; border: 2px solid #8b4513;
      border-radius: 8px; font-size: 1.1em; background: white;
    }
    .spesa-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
    .spesa-row .spesa-desc { 
      flex: 1; padding: 10px; border: 2px solid #8b4513; border-radius: 5px; 
      min-width: 0;
    }
    .spesa-row .spesa-importo { 
      width: 100px; padding: 10px; border: 2px solid #8b4513; border-radius: 5px; 
      flex-shrink: 0;
    }
    .btn-remove { 
      background: linear-gradient(145deg, #9b5523 0%, #8b4513 100%);
      color: #f4e4c1;
      border: 3px solid #2c1810;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1em;
      box-shadow: 
        0 6px 0 #4a2408,
        0 8px 12px rgba(0,0,0,0.6),
        inset 0 2px 0 rgba(255,255,255,0.2),
        inset 0 -2px 0 rgba(0,0,0,0.3);
      transition: all 0.15s;
      position: relative;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    .btn-remove:hover {
      background: linear-gradient(145deg, #ab6533 0%, #9b5523 100%);
      transform: translateY(-2px);
      box-shadow: 
        0 8px 0 #4a2408,
        0 12px 18px rgba(0,0,0,0.7),
        inset 0 2px 0 rgba(255,255,255,0.25),
        inset 0 -2px 0 rgba(0,0,0,0.3);
    }
    .btn-remove:active {
      transform: translateY(4px);
      box-shadow: 
        0 2px 0 #4a2408,
        0 4px 6px rgba(0,0,0,0.5),
        inset 0 1px 0 rgba(255,255,255,0.15),
        inset 0 -1px 0 rgba(0,0,0,0.4);
    }
    .btn-add { 
      background: linear-gradient(145deg, #e8c494 0%, #d4a574 100%);
      color: #2c1810;
      border: 3px solid #8b4513;
      padding: 8px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1em;
      margin-top: 10px;
      box-shadow: 
        0 6px 0 #6b3410,
        0 8px 12px rgba(0,0,0,0.6),
        inset 0 2px 0 rgba(255,255,255,0.4),
        inset 0 -2px 0 rgba(0,0,0,0.2);
      transition: all 0.15s;
      position: relative;
      text-shadow: 0 1px 0 rgba(255,255,255,0.3);
    }
    .btn-add:hover {
      background: linear-gradient(145deg, #f4d4a4 0%, #e6b784 100%);
      transform: translateY(-2px);
      box-shadow: 
        0 8px 0 #6b3410,
        0 12px 18px rgba(0,0,0,0.7),
        inset 0 2px 0 rgba(255,255,255,0.5),
        inset 0 -2px 0 rgba(0,0,0,0.2);
    }
    .btn-add:active {
      transform: translateY(4px);
      box-shadow: 
        0 2px 0 #6b3410,
        0 4px 6px rgba(0,0,0,0.5),
        inset 0 1px 0 rgba(255,255,255,0.3),
        inset 0 -1px 0 rgba(0,0,0,0.3);
    }
    .riepilogo {
      background: linear-gradient(145deg, #e8b873 0%, #c89858 100%);
      padding: 20px; border-radius: 10px; border: 3px solid #3d1f0f; margin-top: 20px;
    }
    .riepilogo h3 { font-family: 'Pirata One'; font-size: 1.8em; color: #2c1810; margin-bottom: 15px; }
    .riepilogo-item {
      display: flex; justify-content: space-between; padding: 10px;
      margin-bottom: 5px; background: rgba(255,255,255,0.5); border-radius: 5px; font-size: 1.1em;
    }
    .discrepanza { font-size: 1.5em; font-weight: bold; padding: 15px; border-radius: 8px; margin-top: 15px; color: #000000; }
    .discrepanza.ok { background: #90ee90; }
    .discrepanza.warning { background: #ffeb3b; }
    .discrepanza.error { background: #ff5252; }
    .btn-salva {
      width: 100%; background: linear-gradient(145deg, #2e8b57 0%, #228b22 100%);
      color: white; padding: 20px; border: 3px solid #1e5631; border-radius: 10px;
      font-size: 1.5em; font-weight: 700; font-family: 'Pirata One'; cursor: pointer;
      margin-top: 20px; box-shadow: 0 6px 0 #1e5631;
    }
    #loading { text-align: center; padding: 50px; font-size: 1.5em; color: #f4e4c1; }
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;
      overflow-y: auto; padding: 20px;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: linear-gradient(145deg, #d4a574 0%, #a67c52 100%);
      padding: 30px; border-radius: 15px; max-width: 800px; width: 100%;
      border: 4px solid #6b4423; box-shadow: 0 30px 60px rgba(0,0,0,0.8);
      max-height: 90vh; overflow-y: auto;
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #8b4513;
    }
    .modal-header h2 { font-family: 'Pirata One'; color: #2c1810; font-size: 2em; }
    .btn-close {
      background: #8b0000; color: white; border: none; padding: 10px 20px;
      border-radius: 8px; cursor: pointer; font-weight: bold; font-family: 'Rye';
    }
    .dettaglio-row {
      display: flex; justify-content: space-between; padding: 10px;
      margin-bottom: 5px; background: rgba(255,255,255,0.5); border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìú Registro di Bordo</h1>
    <a href="index.html" class="btn-home">üè¥‚Äç‚ò†Ô∏è Porto</a>
  </div>
  
  <div id="loading">‚è≥ Caricamento...</div>
  
  <div class="container" id="formChiusura" style="display:none;">
    <div class="info-box">
      <h2>Info Giornaliere</h2>
      <div class="info-item"><strong>Data:</strong> <span id="dataOggi"></span></div>
      <div class="info-item"><strong>Giorno:</strong> <span id="giornoSettimana"></span></div>
      <div class="info-item"><strong>Fondo:</strong> <span id="fondoStart"></span> ‚Ç¨</div>
      <div>
        <button class="btn-precedente" onclick="mostraChiusuraPrecedente()">
          üëÄ Vedi Chiusura Precedente
        </button>
        <div id="loadingPrecedente" style="display:none; margin-top:10px; color:#d4af37; font-style:italic;">
          üè¥‚Äç‚ò†Ô∏è Rovisto tra i registri del capitano...
        </div>
      </div>
    </div>
    
    <div id="alertModifica" class="alert-box" style="display:none;"></div>
    
    <div class="section">
      <div class="section-title">üí∞ Tagli</div>
      <div class="grid" id="tagli"></div>
      <div style="text-align:right; margin-top:15px; font-size:1.3em; font-weight:bold; color:#2c1810;">
        Totale: <span id="totaleContato">0,00</span> ‚Ç¨
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">üîí Fondo e Incassi</div>
      <div style="background: #d9ead3; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #6b4423;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: 700; color: #2c1810; font-size: 1.1em;">Fondo End (automatico):</span>
          <span id="fondoEndDisplay" style="font-size: 1.3em; font-weight: 700; color: #2c1810;">0,00 ‚Ç¨</span>
        </div>
      </div>
      <div class="grid">
        <div class="form-group">
          <label>Chiusura (da stampa):</label>
          <input type="number" id="chiusura" step="0.01" value="0" style="background: #e6f3ff;" oninput="ricalcola()" onfocus="this.select()">
        </div>
        <div class="form-group">
          <label>Cash (portato via):</label>
          <input type="number" id="cash" step="0.01" value="0" oninput="ricalcola()" onfocus="this.select()">
        </div>
        <div class="form-group">
          <label>POS:</label>
          <input type="number" id="pos" step="0.01" value="0" oninput="ricalcola()" onfocus="this.select()">
        </div>
        <div class="form-group">
          <label>Satispay:</label>
          <input type="number" id="satispay" step="0.01" value="0" oninput="ricalcola()" onfocus="this.select()">
        </div>
        <div class="form-group">
          <label>Report Prodotti:</label>
          <input type="number" id="reportProdotti" step="0.01" oninput="ricalcola()" onfocus="this.select()">
        </div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">üí∏ Spese</div>
      <div id="speseContainer"></div>
      <button class="btn-add" onclick="aggiungiSpesa()">‚ûï</button>
      <div style="text-align:right; margin-top:15px; font-size:1.2em; font-weight:bold; color:#2c1810;">
        Tot Spese: <span id="totaleSpese">0,00</span> ‚Ç¨
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">üìù Note</div>
      <textarea id="note" placeholder="Note..." style="width:100%; min-height:80px; padding:12px; border:2px solid #8b4513; border-radius:8px;"></textarea>
    </div>
    
    <div class="riepilogo">
      <h3>‚öñÔ∏è Riepilogo</h3>
      <div class="riepilogo-item"><span>Diff. Fondo:</span><span id="riepDiffFondo">0,00 ‚Ç¨</span></div>
      <div class="riepilogo-item"><span>Totale giorno:</span><span id="riepTotaleGiorno">0,00 ‚Ç¨</span></div>
      <div class="riepilogo-item"><span>Totale cassa:</span><span id="riepTotaleCassa">0,00 ‚Ç¨</span></div>
      <div class="discrepanza" id="discrepanza">Discrepanza: 0,00 ‚Ç¨</div>
    </div>
    
    <button type="button" class="btn-salva" id="btnSalva" onclick="salvaChiusura()">üíæ Salva</button>
  </div>
  
  <div id="modalPrecedente" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìã Chiusura Precedente</h2>
        <button class="btn-close" onclick="chiudiModalPrecedente()">‚úï Chiudi</button>
      </div>
      <div id="contenutoPrecedente"></div>
    </div>
  </div>
  
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzcpybXvlL5Ge24NztvVL3Kz8Jhd3jRHWH0KZmZgKW9577DIqsvXUH7h2lN4ZkzldHisQ/exec';
    
    async function callAPI(action, data = {}) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          redirect: 'follow',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: action, ...data })
        });
        
        const text = await response.text();
        return JSON.parse(text);
      } catch (error) {
        console.error('Errore API:', error);
        throw error;
      }
    }
    
    const TAGLI = [
      {valore:0.10,label:'0,10‚Ç¨'},{valore:0.20,label:'0,20‚Ç¨'},{valore:0.50,label:'0,50‚Ç¨'},
      {valore:1,label:'1‚Ç¨'},{valore:2,label:'2‚Ç¨'},{valore:5,label:'5‚Ç¨'},
      {valore:10,label:'10‚Ç¨'},{valore:20,label:'20‚Ç¨'},{valore:50,label:'50‚Ç¨'},
      {valore:100,label:'100‚Ç¨'}
    ];
    
    const TAGLI_VISIBILI = TAGLI.filter(t => t.valore >= 0.50);
    
    let datiGiorno = null;
    let spese = [];
    let modalitaConsultazione = false;
    
    document.addEventListener('DOMContentLoaded', caricaDatiOggi);
    
    async function caricaDatiOggi() {
      const oggi = new Date();
      const dataStr = `${oggi.getFullYear()}-${String(oggi.getMonth()+1).padStart(2,'0')}-${String(oggi.getDate()).padStart(2,'0')}`;
      
      try {
        datiGiorno = await callAPI('getDatiGiorno', { data: dataStr });
        console.log('DEBUG - Risposta API:', datiGiorno);
        if (datiGiorno.errore) { alert('‚ö†Ô∏è ' + datiGiorno.errore); return; }
        
        // Se fondoStart √® 0 o mancante, cerca fondoEnd del giorno precedente
        if (!datiGiorno.fondoStart || datiGiorno.fondoStart === 0) {
          const fondoEndPrecedente = await cercaFondoEndPrecedente(oggi);
          if (fondoEndPrecedente > 0) {
            datiGiorno.fondoStart = fondoEndPrecedente;
            console.log(`‚úÖ FondoStart impostato da precedente: ${fondoEndPrecedente.toFixed(2)} ‚Ç¨`);
          }
        }
        
        if (datiGiorno.esisteChiusura) {
          modalitaConsultazione = true;
          document.getElementById('alertModifica').style.display = 'block';
          document.getElementById('alertModifica').innerHTML = `
            ‚ö†Ô∏è <strong>Chiusura gi√† registrata</strong> - Modalit√† consultazione
            <button class="btn-modifica" onclick="abilitaModifica()">üîì Modifica</button>
          `;
        }
        
        inizializzaForm();
      } catch (error) {
        alert('‚ö†Ô∏è Errore: ' + error.message);
      }
    }
    
    async function cercaFondoEndPrecedente(dataRiferimento) {
      for (let i = 1; i <= 60; i++) {
        const dataPrecedente = new Date(dataRiferimento);
        dataPrecedente.setDate(dataPrecedente.getDate() - i);
        const dataStr = `${dataPrecedente.getFullYear()}-${String(dataPrecedente.getMonth()+1).padStart(2,'0')}-${String(dataPrecedente.getDate()).padStart(2,'0')}`;
        
        try {
          const risultato = await callAPI('getDatiGiorno', { data: dataStr });
          if (!risultato.errore && risultato.fondoEnd && risultato.fondoEnd > 0) {
            return risultato.fondoEnd;
          }
        } catch (error) {
          continue;
        }
      }
      return 0;
    }
    
    function inizializzaForm() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('formChiusura').style.display = 'block';
      
      document.getElementById('dataOggi').textContent = datiGiorno.data;
      document.getElementById('giornoSettimana').textContent = datiGiorno.giornoSettimana;
      document.getElementById('fondoStart').textContent = datiGiorno.fondoStart.toFixed(2);
      
      const tagliContainer = document.getElementById('tagli');
      TAGLI_VISIBILI.forEach(taglio => {
        const div = document.createElement('div');
        div.className = 'taglio-item';
        div.innerHTML = `
          <span class="taglio-label">${taglio.label}</span>
          <input type="number" class="taglio-input" id="taglio_${taglio.label}" 
                 value="${datiGiorno.tagli[taglio.label]||0}" min="0" step="1" oninput="ricalcolaTagli()" onfocus="this.select()">
          <span class="taglio-total" id="total_${taglio.label}">0,00 ‚Ç¨</span>
        `;
        tagliContainer.appendChild(div);
      });
      
      if (datiGiorno.chiusura) document.getElementById('chiusura').value = datiGiorno.chiusura;
      if (datiGiorno.cash) document.getElementById('cash').value = datiGiorno.cash;
      if (datiGiorno.pos) document.getElementById('pos').value = datiGiorno.pos;
      if (datiGiorno.satispay) document.getElementById('satispay').value = datiGiorno.satispay;
      if (datiGiorno.reportProdotti) document.getElementById('reportProdotti').value = datiGiorno.reportProdotti;
      if (datiGiorno.note) document.getElementById('note').value = datiGiorno.note;
      
      spese = datiGiorno.spese && datiGiorno.spese.length > 0 ? datiGiorno.spese : [{ descrizione: '', importo: 0 }];
      aggiornaSpese();
      ricalcolaTagli(); // Calcola i totali dei tagli prima di ricalcola()
      ricalcola();
      
      if (modalitaConsultazione) {
        bloccaCampi();
      }
    }
    
    function bloccaCampi() {
      document.querySelectorAll('input[type="number"], textarea').forEach(el => {
        el.disabled = true;
        el.style.background = '#f5f5f5';
        el.style.cursor = 'not-allowed';
      });
      
      document.querySelectorAll('.taglio-input').forEach(el => {
        el.disabled = true;
        el.style.background = '#f5f5f5';
        el.style.cursor = 'not-allowed';
      });
      
      document.getElementById('btnSalva').style.display = 'none';
      
      document.querySelectorAll('.btn-add, .btn-remove').forEach(btn => {
        btn.style.display = 'none';
      });
    }
    
    function sbloccaCampi() {
      document.querySelectorAll('input[type="number"], textarea').forEach(el => {
        el.disabled = false;
        el.style.background = '';
        el.style.cursor = '';
      });
      
      document.querySelectorAll('.taglio-input').forEach(el => {
        el.disabled = false;
        el.style.background = 'white';
        el.style.cursor = '';
      });
      
      const btnSalva = document.getElementById('btnSalva');
      btnSalva.style.display = 'block';
      btnSalva.textContent = 'üíæ Salva Modifiche';
      
      document.querySelectorAll('.btn-add').forEach(btn => {
        btn.style.display = 'inline-block';
      });
      
      document.querySelectorAll('.btn-remove').forEach(btn => {
        btn.style.display = 'inline-block';
      });
    }
    
    function abilitaModifica() {
      if (!confirm('‚ö†Ô∏è Stai per modificare una chiusura gi√† registrata.\n\nSei sicuro di voler procedere?')) {
        return;
      }
      
      modalitaConsultazione = false;
      sbloccaCampi();
      
      document.getElementById('alertModifica').innerHTML = `
        <div style="background:#d4edda; padding:12px; border-radius:8px; border:1px solid #28a745;">
          ‚úèÔ∏è <strong>Modalit√† modifica attiva</strong> - Puoi modificare i dati
        </div>
      `;
    }
    
    function ricalcolaTagli() {
      let totale = 0;
      TAGLI_VISIBILI.forEach(taglio => {
        const qta = parseFloat(document.getElementById(`taglio_${taglio.label}`).value) || 0;
        const valore = qta * taglio.valore;
        totale += valore;
        document.getElementById(`total_${taglio.label}`).textContent = valore.toFixed(2) + ' ‚Ç¨';
      });
      document.getElementById('totaleContato').textContent = totale.toFixed(2);
      document.getElementById('fondoEndDisplay').textContent = totale.toFixed(2) + ' ‚Ç¨';
      ricalcola();
    }
    
    function aggiungiSpesa() {
      spese.push({ descrizione: '', importo: 0 });
      aggiornaSpese();
    }
    
    function rimuoviSpesa(index) {
      spese.splice(index, 1);
      aggiornaSpese();
    }
    
    function aggiornaSpese() {
      const container = document.getElementById('speseContainer');
      container.innerHTML = '';
      spese.forEach((spesa, index) => {
        const div = document.createElement('div');
        div.className = 'spesa-row';
        div.innerHTML = `
          <input type="text" class="spesa-desc" placeholder="Descrizione" value="${spesa.descrizione}"
                 onchange="spese[${index}].descrizione = this.value">
          <input type="number" class="spesa-importo" placeholder="0.00" step="0.01" value="${spesa.importo}"
                 oninput="spese[${index}].importo = parseFloat(this.value)||0; ricalcola()" onfocus="this.select()">
          <button class="btn-remove" onclick="rimuoviSpesa(${index})">‚ùå</button>
        `;
        container.appendChild(div);
      });
      ricalcola();
    }
    
    function ricalcola() {
      const fondoStart = parseFloat(document.getElementById('fondoStart').textContent) || 0;
      const fondoEnd = parseFloat(document.getElementById('totaleContato').textContent) || 0;
      const cash = parseFloat(document.getElementById('cash').value) || 0;
      const pos = parseFloat(document.getElementById('pos').value) || 0;
      const satispay = parseFloat(document.getElementById('satispay').value) || 0;
      const reportProdotti = parseFloat(document.getElementById('reportProdotti').value) || 0;
      const totaleSpese = spese.reduce((sum, s) => sum + (s.importo||0), 0);
      
      document.getElementById('totaleSpese').textContent = totaleSpese.toFixed(2);
      
      const diffFondo = fondoEnd - fondoStart;
      const totaleGiorno = cash + pos + satispay + totaleSpese;
      const totaleCassa = totaleGiorno + diffFondo;
      const discrepanza = totaleCassa - reportProdotti;
      
      document.getElementById('riepDiffFondo').textContent = diffFondo.toFixed(2) + ' ‚Ç¨';
      document.getElementById('riepTotaleGiorno').textContent = totaleGiorno.toFixed(2) + ' ‚Ç¨';
      document.getElementById('riepTotaleCassa').textContent = totaleCassa.toFixed(2) + ' ‚Ç¨';
      
      const discEl = document.getElementById('discrepanza');
      // ‚ö° Segno + per eccedenze
      const segno = discrepanza > 0 ? '+' : '';
      discEl.textContent = `Discrepanza: ${segno}${discrepanza.toFixed(2)} ‚Ç¨`;
      discEl.className = 'discrepanza';
      // ‚ö° Nuove soglie: Verde ‚â§5‚Ç¨, Giallo ‚â§15‚Ç¨, Rosso >15‚Ç¨
      if (Math.abs(discrepanza) <= 5) discEl.classList.add('ok');
      else if (Math.abs(discrepanza) <= 15) discEl.classList.add('warning');
      else discEl.classList.add('error');
    }
    
    async function mostraChiusuraPrecedente() {
      try {
        document.getElementById('loadingPrecedente').style.display = 'block';
        
        const oggi = new Date();
        let dati = null;
        let giornoTrovato = false;
        
        for (let i = 1; i <= 30; i++) {
          const dataPrecedente = new Date(oggi);
          dataPrecedente.setDate(dataPrecedente.getDate() - i);
          const dataStr = `${dataPrecedente.getFullYear()}-${String(dataPrecedente.getMonth()+1).padStart(2,'0')}-${String(dataPrecedente.getDate()).padStart(2,'0')}`;
          
          const risultato = await callAPI('getDatiGiorno', { data: dataStr });
          
          if (!risultato.errore && risultato.fondoEnd && risultato.fondoEnd > 0) {
            dati = risultato;
            giornoTrovato = true;
            break;
          }
        }
        
        if (!giornoTrovato || !dati) {
          document.getElementById('loadingPrecedente').style.display = 'none';
          alert('‚ö†Ô∏è Nessuna chiusura precedente trovata negli ultimi 30 giorni');
          return;
        }
        
        let tagliHtml = '<div class="section"><div class="section-title">üí∞ Tagli</div>';
        let haTagli = false;
        for (const [taglio, qta] of Object.entries(dati.tagli || {})) {
          if (qta > 0) {
            haTagli = true;
            tagliHtml += `<div class="dettaglio-row"><span>${taglio}:</span><span>${qta} pz</span></div>`;
          }
        }
        tagliHtml += haTagli ? '</div>' : '<div style="color:#666; font-style:italic;">Nessun taglio registrato</div></div>';
        
        let speseHtml = '<div class="section"><div class="section-title">üí∏ Spese</div>';
        let hasDettaglioSpese = false;
        if (dati.spese && dati.spese.length > 0) {
          dati.spese.forEach(spesa => {
            if (spesa.descrizione || spesa.importo) {
              hasDettaglioSpese = true;
              speseHtml += `<div class="dettaglio-row"><span>${spesa.descrizione || 'N/A'}:</span><span>${spesa.importo.toFixed(2)} ‚Ç¨</span></div>`;
            }
          });
        }
        
        speseHtml += `<div class="dettaglio-row" style="font-weight:700; border-top:2px solid #333; margin-top:5px; padding-top:5px;">
          <span>üí∏ Tot Spese:</span><span>${dati.totaleSpese.toFixed(2)} ‚Ç¨</span>
        </div>`;
        
        if (!hasDettaglioSpese) {
          speseHtml = '<div class="section"><div class="section-title">üí∏ Spese</div><div style="color:#666; font-style:italic;">Nessun dettaglio spese</div>' + speseHtml.split('</div>').slice(-2).join('</div>');
        }
        speseHtml += '</div>';
        
        const html = `
          <div class="info-box">
            <h2>${dati.giornoSettimana} ${dati.data}</h2>
          </div>
          <div class="section">
            <div class="section-title">üìä Riepilogo</div>
            <div class="dettaglio-row"><span>Fondo Start:</span><span>${dati.fondoStart.toFixed(2)} ‚Ç¨</span></div>
            <div class="dettaglio-row"><span>Fondo End:</span><span>${dati.fondoEnd.toFixed(2)} ‚Ç¨</span></div>
            <div class="dettaglio-row"><span>Chiusura:</span><span>${dati.chiusura.toFixed(2)} ‚Ç¨</span></div>
            <div class="dettaglio-row"><span>Cash:</span><span>${dati.cash.toFixed(2)} ‚Ç¨</span></div>
            <div class="dettaglio-row"><span>POS:</span><span>${dati.pos.toFixed(2)} ‚Ç¨</span></div>
            <div class="dettaglio-row"><span>Satispay:</span><span>${dati.satispay.toFixed(2)} ‚Ç¨</span></div>
            <div class="dettaglio-row"><span>Report Prodotti:</span><span>${dati.reportProdotti.toFixed(2)} ‚Ç¨</span></div>
            <div class="dettaglio-row" style="font-weight:700; background:${Math.abs(dati.discrepanza) <= 5 ? '#90ee90' : (Math.abs(dati.discrepanza) <= 15 ? '#ffeb3b' : '#ff5252')};">
              <span>‚ö†Ô∏è Discrepanza:</span><span>${dati.discrepanza > 0 ? '+' : ''}${dati.discrepanza.toFixed(2)} ‚Ç¨</span>
            </div>
          </div>
          ${tagliHtml}
          ${speseHtml}
          ${dati.note ? `<div class="section">
            <div class="section-title">üìù Note</div>
            <div style="padding:10px; background:white; border-radius:5px;">${dati.note}</div>
          </div>` : ''}
        `;
        
        document.getElementById('contenutoPrecedente').innerHTML = html;
        document.getElementById('loadingPrecedente').style.display = 'none';
        document.getElementById('modalPrecedente').classList.add('active');
      } catch (error) {
        document.getElementById('loadingPrecedente').style.display = 'none';
        alert('‚ö†Ô∏è Errore: ' + error.message);
      }
    }
    
    function chiudiModalPrecedente() {
      document.getElementById('modalPrecedente').classList.remove('active');
    }
    
    async function salvaChiusura() {
      if (modalitaConsultazione) {
        alert('‚ùå Non puoi salvare in modalit√† consultazione.\n\nUsa il bottone "Modifica" prima.');
        return;
      }
      
      // Mostra loading sul bottone
      const btnSalva = document.getElementById('btnSalva');
      const testoOriginale = btnSalva.textContent;
      btnSalva.disabled = true;
      btnSalva.textContent = '‚è≥ Salvataggio in corso...';
      btnSalva.style.opacity = '0.7';
      btnSalva.style.cursor = 'not-allowed';
      
      const tagli = {};
      TAGLI.forEach(taglio => {
        const input = document.getElementById(`taglio_${taglio.label}`);
        tagli[taglio.label] = input ? (parseInt(input.value) || 0) : 0;
      });
      
      const dati = {
        data: datiGiorno.data.split('/').reverse().join('-'),
        fondoStart: datiGiorno.fondoStart || 0,
        tagli: tagli,
        chiusura: parseFloat(document.getElementById('chiusura').value) || 0,
        cash: parseFloat(document.getElementById('cash').value) || 0,
        pos: parseFloat(document.getElementById('pos').value) || 0,
        satispay: parseFloat(document.getElementById('satispay').value) || 0,
        reportProdotti: parseFloat(document.getElementById('reportProdotti').value) || 0,
        spese: spese.filter(s => s.descrizione || s.importo),
        note: document.getElementById('note').value,
        utente: 'Web'
      };
      
      try {
        const result = await callAPI('salvaChiusura', { dati: dati });
        if (result.successo) {
          alert('‚úÖ Chiusura salvata con successo!');
          window.location.href = 'index.html';
        } else {
          alert('‚ö†Ô∏è Errore: ' + result.errore);
          // Ripristina bottone in caso di errore
          btnSalva.disabled = false;
          btnSalva.textContent = testoOriginale;
          btnSalva.style.opacity = '';
          btnSalva.style.cursor = '';
        }
      } catch (error) {
        alert('‚ö†Ô∏è Errore: ' + error.message);
        // Ripristina bottone in caso di errore
        btnSalva.disabled = false;
        btnSalva.textContent = testoOriginale;
        btnSalva.style.opacity = '';
        btnSalva.style.cursor = '';
      }
    }
  </script>
  
  <script>
  const RELOAD_KEY = 'sw_reloading';
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => {
        setInterval(() => reg.update(), 60000);
        reg.addEventListener('updatefound', () => {
          const newSW = reg.installing;
          newSW.addEventListener('statechange', () => {
            if (newSW.state === 'activated' && !sessionStorage.getItem(RELOAD_KEY)) {
              sessionStorage.setItem(RELOAD_KEY, 'true');
              setTimeout(() => window.location.reload(), 500);
            }
          });
        });
      })
      .catch(err => console.log('‚ùå SW:', err));
    
    let reloadTriggered = false;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (!reloadTriggered && !sessionStorage.getItem(RELOAD_KEY)) {
        reloadTriggered = true;
        sessionStorage.setItem(RELOAD_KEY, 'true');
        setTimeout(() => window.location.reload(), 500);
      }
    });
    
    window.addEventListener('load', () => {
      setTimeout(() => sessionStorage.removeItem(RELOAD_KEY), 2000);
    });
  }
  </script>
</body>
</html>
