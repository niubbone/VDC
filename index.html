<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üè¥‚Äç‚ò†Ô∏è Gestione Vecchia Dogana</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Sistema di gestione del galeone Vecchia Dogana">
  <meta name="theme-color" content="#14283c">
  <link rel="manifest" href="./manifest.json">
  
  <!-- iOS Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Vecchia Dogana">
  <link rel="apple-touch-icon" href="./assets/icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./assets/icons/icon-180x180.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="./assets/icons/icon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./assets/icons/icon-16x16.png">
  
  <link href="https://fonts.googleapis.com/css2?family=Pirata+One&family=Rye&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Georgia', serif;
      background: 
        linear-gradient(rgba(20, 40, 60, 0.40), rgba(20, 40, 60, 0.40)),
        url('./assets/images/SfondoVD.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh; 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      padding: 20px;
    }
    .container {
      background: linear-gradient(145deg, #d4a574 0%, #a67c52 100%);
      padding: 50px 40px; border-radius: 15px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.6); max-width: 500px; width: 100%;
      border: 4px solid #6b4423; position: relative;
    }
    .logo { text-align: center; margin-bottom: 40px; }
    .logo h1 {
      font-family: 'Pirata One', cursive; font-size: 2.8em; color: #3d1f0f; margin-bottom: 5px;
      text-shadow: 2px 2px 0 #d4a574, 3px 3px 0 rgba(0,0,0,0.3); letter-spacing: 2px;
    }
    .logo .skull { font-size: 3em; display: block; margin-bottom: 10px; animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    .logo p { font-family: 'Rye', cursive; color: #2c1810; font-size: 1.1em; font-style: italic; }
    .btn-group { display: flex; flex-direction: column; gap: 20px; margin-top: 30px; }
    .btn {
      padding: 18px 30px; border: 3px solid #3d1f0f; border-radius: 8px; font-size: 1.2em;
      font-weight: 700; font-family: 'Rye', cursive; cursor: pointer; transition: all 0.3s;
      text-decoration: none; text-align: center; display: block; position: relative;
      box-shadow: 0 4px 0 #3d1f0f, 0 8px 20px rgba(0,0,0,0.4);
    }
    .btn:active { transform: translateY(4px); box-shadow: 0 0 0 #3d1f0f, 0 4px 10px rgba(0,0,0,0.4); }
    .btn-primary {
      background: linear-gradient(145deg, #e8b873 0%, #c89858 100%); color: #2c1810;
    }
    .btn-secondary {
      background: linear-gradient(145deg, #8b4513 0%, #654321 100%); color: #f4e4c1;
    }
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: linear-gradient(145deg, #d4a574 0%, #a67c52 100%);
      padding: 40px; border-radius: 15px; max-width: 450px; width: 90%;
      border: 4px solid #6b4423; box-shadow: 0 30px 60px rgba(0,0,0,0.8);
    }
    .modal-content h2 {
      font-family: 'Pirata One', cursive; font-size: 2em; text-align: center;
      color: #2c1810; margin-bottom: 25px;
    }
    .form-group { margin-bottom: 25px; }
    .form-group label {
      display: block; margin-bottom: 8px; color: #2c1810;
      font-weight: 700; font-family: 'Rye', cursive; font-size: 1.1em;
    }
    .form-group input {
      width: 100%; padding: 15px; border: 3px solid #6b4423; border-radius: 8px;
      font-size: 1.3em; font-family: monospace; font-weight: bold;
      text-align: center; letter-spacing: 8px; background: #f4e4c1; color: #2c1810;
    }
    .modal-buttons { display: flex; gap: 15px; margin-top: 25px; }
    .modal-buttons button { flex: 1; }
    .btn-cancel {
      background: linear-gradient(145deg, #558b2f 0%, #33691e 100%);
      color: white;
      border: 3px solid #3d1f0f;
      border-radius: 8px;
      padding: 18px 30px;
      font-size: 1.2em;
      font-weight: 700;
      font-family: 'Rye', cursive;
      cursor: pointer;
      box-shadow: 0 4px 0 #3d1f0f, 0 8px 20px rgba(0,0,0,0.4);
      transition: all 0.15s;
    }
    .btn-cancel:hover {
      background: linear-gradient(145deg, #689f38 0%, #558b2f 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 0 #3d1f0f, 0 10px 25px rgba(0,0,0,0.5);
    }
    .btn-cancel:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 #3d1f0f, 0 4px 10px rgba(0,0,0,0.4);
    }
    #errorePin {
      color: #8b0000; background: #ffcccc; padding: 12px; border-radius: 8px;
      margin-top: 15px; display: none; text-align: center; font-weight: bold; border: 2px solid #8b0000;
    }
    
    /* BOTTONE SPESE RAPIDE */
    .btn-spese-rapide {
      background: linear-gradient(145deg, #e8b873 0%, #c89858 100%);
      color: #2c1810;
      font-size: 1.2em;
      padding: 15px 30px;
    }
    .btn-spese-rapide:hover {
      background: linear-gradient(145deg, #f0c890 0%, #d4a574 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 0 #3d1f0f, 0 10px 25px rgba(0,0,0,0.5);
    }
    .btn-primary:hover {
      background: linear-gradient(145deg, #f0c890 0%, #d4a574 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 0 #3d1f0f, 0 10px 25px rgba(0,0,0,0.5);
    }
    .btn-secondary:hover {
      background: linear-gradient(145deg, #a0522d 0%, #7a3e1e 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 0 #3d1f0f, 0 10px 25px rgba(0,0,0,0.5);
    }
    
    /* MODAL SPESE RAPIDE */
    .spesa-item {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 2px solid rgba(212, 165, 116, 0.3);
    }
    .spesa-item.spesa-esistente {
      background: rgba(255,255,255,0.15);
    }
    .spesa-item.spesa-nuova {
      background: rgba(144, 238, 144, 0.15);
      border: 2px dashed #52c652;
    }
    .spesa-item input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 2px solid #6b4423;
      border-radius: 5px;
      font-size: 1em;
      background: #f4e4c1;
      color: #2c1810;
    }
    .spesa-item input[type="text"]:read-only {
      background: #e0e0e0;
      color: #555;
    }
    .spesa-item input:last-child {
      margin-bottom: 0;
    }
    .sezione-spese {
      margin-bottom: 20px;
    }
    .sezione-title {
      font-weight: bold;
      color: #f4e4c1;
      margin-bottom: 15px;
      font-size: 1.1em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    .divider {
      border-top: 2px solid rgba(212, 165, 116, 0.4);
      margin: 25px 0;
    }
    .btn-elimina-inline {
      background: linear-gradient(145deg, #c62828 0%, #8b0000 100%);
      color: white;
      border: 2px solid #6a0000;
      border-radius: 5px;
      padding: 10px 15px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 3px 0 #4a0000, 0 5px 10px rgba(0,0,0,0.4);
      transition: all 0.15s;
      width: 100%;
      margin-top: 5px;
    }
    .btn-elimina-inline:hover {
      background: linear-gradient(145deg, #d32f2f 0%, #9b0000 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 0 #4a0000, 0 7px 15px rgba(0,0,0,0.5);
    }
    .btn-elimina-inline:active {
      transform: translateY(3px);
      box-shadow: 0 0 0 #4a0000, 0 2px 5px rgba(0,0,0,0.4);
    }
    .btn-add-spesa {
      background: linear-gradient(145deg, #e8b873 0%, #c89858 100%);
      color: #2c1810;
      border: 3px solid #3d1f0f;
      border-radius: 8px;
      padding: 18px 30px;
      font-size: 1.2em;
      font-weight: 700;
      font-family: 'Rye', cursive;
      cursor: pointer;
      box-shadow: 0 4px 0 #3d1f0f, 0 8px 20px rgba(0,0,0,0.4);
      transition: all 0.15s;
      width: 100%;
      margin-top: 10px;
    }
    .btn-add-spesa:hover {
      background: linear-gradient(145deg, #f0c890 0%, #d4a574 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 0 #3d1f0f, 0 10px 25px rgba(0,0,0,0.5);
    }
    .btn-add-spesa:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 #3d1f0f, 0 4px 10px rgba(0,0,0,0.4);
    }
    .btn-rimuovi-spesa {
      background: linear-gradient(145deg, #c62828 0%, #8b0000 100%);
      color: white;
      border: 2px solid #6a0000;
      border-radius: 5px;
      padding: 8px 15px;
      font-size: 0.9em;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 3px 0 #4a0000, 0 5px 10px rgba(0,0,0,0.4);
      transition: all 0.15s;
      margin-top: 5px;
    }
    .btn-rimuovi-spesa:hover {
      background: linear-gradient(145deg, #d32f2f 0%, #9b0000 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 0 #4a0000, 0 7px 15px rgba(0,0,0,0.5);
    }
    .btn-rimuovi-spesa:active {
      transform: translateY(3px);
      box-shadow: 0 0 0 #4a0000, 0 2px 5px rgba(0,0,0,0.4);
    }
    #messaggioSpese {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      display: none;
      text-align: center;
      font-weight: bold;
    }
    #messaggioSpese.successo {
      background: #90EE90;
      color: #2c5f2d;
      border: 2px solid #2c5f2d;
    }
    #messaggioSpese.errore {
      background: #ffcccc;
      color: #8b0000;
      border: 2px solid #8b0000;
    }
    
    
    /* FOOTER IN FONDO */
    .footer {
      text-align: center; 
      margin-top: 20px;
      margin-bottom: 30px;
      color: #d4a574; 
      font-size: 1.05em;
      font-style: italic; 
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }
    @media (max-width: 600px) {
      .container { padding: 30px 20px; }
      .logo h1 { font-size: 2em; }
    }
    
    /* CONTROLLO AUDIO */
    .audio-control {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(145deg, #d4a574 0%, #a67c52 100%);
      border: 3px solid #6b4423;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
      transition: all 0.3s;
      z-index: 1000;
    }
    
    .audio-control:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.6);
    }
    
    .audio-control:active {
      transform: translateY(0);
    }
    
    .audio-icon {
      font-size: 1.8em;
      filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
    }
    
    .audio-control.muted {
      opacity: 0.6;
    }
    
    @media (max-width: 600px) {
      .audio-control {
        width: 50px;
        height: 50px;
        bottom: 15px;
        right: 15px;
      }
      .audio-icon {
        font-size: 1.5em;
      }
    }
    
    /* LOADING SPINNER */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #d4a574;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #d4a574;
      font-family: 'Pirata One';
      font-size: 1.5em;
      margin-top: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- LOADING OVERLAY -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-container">
      <div class="spinner"></div>
      <div class="loading-text">Verifico il codice...</div>
    </div>
  </div>
  
  <!-- AUDIO BACKGROUND -->
  <audio id="bgMusic" loop>
    <source src="./assets/audio/musica-sottofondo.mp3" type="audio/mpeg">
  </audio>
  
  <!-- CONTROLLO AUDIO -->
  <div class="audio-control" id="audioControl" onclick="toggleAudio()" title="Click per attivare/disattivare musica">
    <span class="audio-icon" id="audioIcon">üéµ</span>
  </div>
  
  <div class="container">
    <div class="logo">
      <span class="skull">üè¥‚Äç‚ò†Ô∏è</span>
      <h1>Vecchia Dogana</h1>
      <p>Gestione del Tesoro della Cassa</p>
    </div>
    <div class="btn-group">
      <button class="btn btn-spese-rapide" onclick="mostraModalSpeseRapide()">üí∏ Inserisci Spesa Rapida</button>
      <a href="prenotazioni.html" class="btn btn-spese-rapide">‚öì Prenotazioni</a>
      <a href="chiusura.html" class="btn btn-primary">üìú Registra Chiusura</a>
      <button class="btn btn-secondary" onclick="mostraModalPIN()">üé© Accesso Capitano</button>
    </div>
  </div>
  
  <!-- FOOTER IN FONDO -->
  <div class="footer">
    <p>‚öì   Ver. <span id="appVersion">caricamento...</span>   ‚öì</p>
  </div>
  
  <div id="modalPIN" class="modal">
    <div class="modal-content">
      <h2>Codice Segreto</h2>
      <div class="form-group">
        <label for="pinInput">PIN Capitano:</label>
        <input type="password" id="pinInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
      </div>
      <div class="modal-buttons">
        <button class="btn btn-cancel" onclick="chiudiModalPIN()">Indietro</button>
        <button class="btn btn-primary" onclick="verificaPIN()">Entra</button>
      </div>
      <div id="errorePin">‚ö†Ô∏è Codice errato! Riprova.</div>
    </div>
  </div>
  
  <!-- MODAL SPESE RAPIDE -->
  <div id="modalSpeseRapide" class="modal">
    <div class="modal-content">
      <h2>üí∏ Gestisci Spese</h2>
      <p style="color: #f4e4c1; font-size: 0.9em; margin-bottom: 20px; font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
        Spese della chiusura di <strong><span id="dataSpeseModal"></span></strong>
      </p>
      
      <!-- SPESE ESISTENTI -->
      <div id="sezioneEsistenti" style="display:none;">
        <div class="sezione-spese">
          <div class="sezione-title">üìã Spese gi√† inserite</div>
          <div id="containerSpeseEsistenti"></div>
        </div>
        <div class="divider"></div>
      </div>
      
      <!-- NUOVE SPESE -->
      <div class="sezione-spese">
        <div class="sezione-title">‚ûï Aggiungi nuove spese</div>
        <div id="containerNuoveSpese"></div>
      </div>
      
      <button class="btn btn-add-spesa" onclick="aggiungiCampoSpesa()">‚ûï Aggiungi Altra Spesa</button>
      <div id="messaggioSpese"></div>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button class="btn btn-cancel" onclick="chiudiModalSpeseRapide()">üíæ Salva e Chiudi</button>
      </div>
    </div>
  </div>
  
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzcpybXvlL5Ge24NztvVL3Kz8Jhd3jRHWH0KZmZgKW9577DIqsvXUH7h2lN4ZkzldHisQ/exec';
    
    async function callAPI(action, data = {}) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          redirect: 'follow',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: action, ...data })
        });
        
        const text = await response.text();
        return JSON.parse(text);
      } catch (error) {
        console.error('Errore API:', error);
        throw error;
      }
    }
    
    function mostraModalPIN() {
      document.getElementById('modalPIN').classList.add('active');
      document.getElementById('pinInput').focus();
    }
    
    function chiudiModalPIN() {
      document.getElementById('modalPIN').classList.remove('active');
      document.getElementById('pinInput').value = '';
      document.getElementById('errorePin').style.display = 'none';
    }
    
    async function verificaPIN() {
      const pin = document.getElementById('pinInput').value;
      if (!pin) { alert('‚ö†Ô∏è Inserisci il codice segreto!'); return; }
      
      // Mostra spinner
      document.getElementById('loadingOverlay').classList.add('active');
      
      try {
        const result = await callAPI('verificaPIN', { pin: pin });
        
        // Nascondi spinner
        document.getElementById('loadingOverlay').classList.remove('active');
        
        if (result.valido) {
          sessionStorage.setItem('auth', 'titolare');
          window.location.href = 'dashboard.html';
        } else {
          document.getElementById('errorePin').style.display = 'block';
          setTimeout(() => document.getElementById('errorePin').style.display = 'none', 3000);
        }
      } catch (error) {
        // Nascondi spinner anche in caso di errore
        document.getElementById('loadingOverlay').classList.remove('active');
        alert('‚ö†Ô∏è Errore di connessione: ' + error.message);
      }
    }
    
    document.getElementById('pinInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') verificaPIN();
    });
    
    // ===== GESTIONE SPESE RAPIDE =====
    let speseEsistenti = [];
    let nuoveSpese = [];
    let dataSpese = null;
    
    async function mostraModalSpeseRapide() {
      // ‚≠ê APERTURA IMMEDIATA (no delay)
      document.getElementById('modalSpeseRapide').classList.add('active');
      
      // Calcola data
      const ora = new Date();
      const oraCorrente = ora.getHours();
      let data;
      
      if (oraCorrente >= 0 && oraCorrente < 4) {
        const ieri = new Date(ora);
        ieri.setDate(ieri.getDate() - 1);
        data = new Date(ieri.getFullYear(), ieri.getMonth(), ieri.getDate());
      } else {
        data = new Date(ora.getFullYear(), ora.getMonth(), ora.getDate());
      }
      
      dataSpese = `${data.getFullYear()}-${String(data.getMonth()+1).padStart(2,'0')}-${String(data.getDate()).padStart(2,'0')}`;
      const dataDisplay = `${String(data.getDate()).padStart(2,'0')}/${String(data.getMonth()+1).padStart(2,'0')}/${data.getFullYear()}`;
      
      document.getElementById('dataSpeseModal').textContent = dataDisplay;
      
      nuoveSpese = [];
      document.getElementById('messaggioSpese').style.display = 'none';
      
      // Aggiungi prima spesa vuota subito
      aggiungiCampoSpesa();
      
      // ‚≠ê Carica spese esistenti in background (async)
      caricaSpeseEsistenti();
    }
    
    async function caricaSpeseEsistenti() {
      try {
        const datiGiorno = await callAPI('getDatiGiorno', { data: dataSpese });
        speseEsistenti = datiGiorno.spese || [];
        renderSpeseEsistenti();
      } catch (error) {
        console.error('Errore caricamento spese:', error);
        speseEsistenti = [];
      }
    }
    
    function renderSpeseEsistenti() {
      const container = document.getElementById('containerSpeseEsistenti');
      const sezione = document.getElementById('sezioneEsistenti');
      
      if (speseEsistenti.length === 0) {
        sezione.style.display = 'none';
        return;
      }
      
      sezione.style.display = 'block';
      container.innerHTML = '';
      
      speseEsistenti.forEach((spesa, index) => {
        const div = document.createElement('div');
        div.className = 'spesa-item spesa-esistente';
        div.innerHTML = `
          <input type="text" value="${spesa.descrizione}" readonly>
          <input type="number" value="${spesa.importo}" step="0.01" min="0" 
                 placeholder="Importo ‚Ç¨" onchange="modificaSpesaEsistente(${index}, this.value)">
          <button class="btn-elimina-inline" onclick="eliminaSpesaEsistente(${index})">üóëÔ∏è Elimina</button>
        `;
        container.appendChild(div);
      });
    }
    
    function renderNuoveSpese() {
      const container = document.getElementById('containerNuoveSpese');
      container.innerHTML = '';
      
      nuoveSpese.forEach((spesa, index) => {
        const div = document.createElement('div');
        div.className = 'spesa-item spesa-nuova';
        div.id = `nuova-spesa-${index}`;
        div.innerHTML = `
          <input type="text" id="nuova-desc-${index}" placeholder="Descrizione spesa..." 
                 value="${spesa.descrizione}" onchange="aggiornaNuovaSpesa(${index})">
          <input type="number" id="nuova-importo-${index}" placeholder="Importo ‚Ç¨" step="0.01" min="0"
                 value="${spesa.importo || ''}" onchange="aggiornaNuovaSpesa(${index})">
          ${index > 0 ? `<button class="btn-elimina-inline" onclick="rimuoviNuovaSpesa(${index})">üóëÔ∏è Rimuovi</button>` : ''}
        `;
        container.appendChild(div);
      });
    }
    
    function modificaSpesaEsistente(index, nuovoImporto) {
      speseEsistenti[index].importo = parseFloat(nuovoImporto) || 0;
      salvaSpesaAutomatica();
    }
    
    function eliminaSpesaEsistente(index) {
      if (!confirm(`Eliminare la spesa "${speseEsistenti[index].descrizione}"?`)) return;
      speseEsistenti.splice(index, 1);
      renderSpeseEsistenti();
      salvaSpesaAutomatica();
    }
    
    function aggiungiCampoSpesa() {
      nuoveSpese.push({ descrizione: '', importo: 0 });
      renderNuoveSpese();
      const index = nuoveSpese.length - 1;
      setTimeout(() => {
        const input = document.getElementById(`nuova-desc-${index}`);
        if (input) input.focus();
      }, 100);
    }
    
    function aggiornaNuovaSpesa(index) {
      const desc = document.getElementById(`nuova-desc-${index}`).value.trim();
      const importo = parseFloat(document.getElementById(`nuova-importo-${index}`).value) || 0;
      
      nuoveSpese[index] = { descrizione: desc, importo: importo };
      
      if (desc && importo > 0) {
        salvaSpesaAutomatica();
      }
    }
    
    function rimuoviNuovaSpesa(index) {
      nuoveSpese.splice(index, 1);
      renderNuoveSpese();
    }
    
    async function salvaSpesaAutomatica() {
      const nuoveValide = nuoveSpese.filter(s => s.descrizione && s.importo > 0);
      const tutteSpese = [...speseEsistenti, ...nuoveValide];
      
      if (tutteSpese.length === 0) return;
      
      try {
        await callAPI('salvaChiusura', {
          data: dataSpese,
          dati: { spese: tutteSpese }
        });
        
        const msg = document.getElementById('messaggioSpese');
        msg.textContent = '‚úÖ Spese salvate';
        msg.className = 'successo';
        msg.style.display = 'block';
        setTimeout(() => msg.style.display = 'none', 2000);
        
      } catch (error) {
        console.error('Errore salvataggio:', error);
        const msg = document.getElementById('messaggioSpese');
        msg.textContent = '‚ö†Ô∏è Errore salvataggio';
        msg.className = 'errore';
        msg.style.display = 'block';
      }
    }
    
    function chiudiModalSpeseRapide() {
      document.getElementById('modalSpeseRapide').classList.remove('active');
    }
    // ===== FINE GESTIONE SPESE RAPIDE =====
    
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SERVICE WORKER - v3.6.0 con protezione anti-loop
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const RELOAD_KEY = 'sw_reloading';
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => {
          console.log('‚úÖ SW registrato');
          setInterval(() => reg.update(), 60000);
          
          reg.addEventListener('updatefound', () => {
            const newSW = reg.installing;
            newSW.addEventListener('statechange', () => {
              if (newSW.state === 'activated' && !sessionStorage.getItem(RELOAD_KEY)) {
                sessionStorage.setItem(RELOAD_KEY, 'true');
                setTimeout(() => window.location.reload(), 500);
              }
            });
          });
        })
        .catch(err => console.log('‚ùå SW:', err));
      
      let reloadTriggered = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!reloadTriggered && !sessionStorage.getItem(RELOAD_KEY)) {
          reloadTriggered = true;
          sessionStorage.setItem(RELOAD_KEY, 'true');
          setTimeout(() => window.location.reload(), 500);
        }
      });
      
      window.addEventListener('load', () => {
        setTimeout(() => sessionStorage.removeItem(RELOAD_KEY), 2000);
      });
      
      navigator.serviceWorker.ready.then(() => {
        const mc = new MessageChannel();
        mc.port1.onmessage = (e) => {
          if (e.data.version) {
            const el = document.getElementById('appVersion');
            if (el) el.textContent = e.data.version;
          }
        };
        navigator.serviceWorker.controller?.postMessage({ type: 'GET_VERSION' }, [mc.port2]);
      });
    }
  </script>
  
  <script>
    // GESTIONE AUDIO SOTTOFONDO
    const bgMusic = document.getElementById('bgMusic');
    const audioControl = document.getElementById('audioControl');
    const audioIcon = document.getElementById('audioIcon');
    let audioPlaying = false;
    
    // Funzione toggle audio
    function toggleAudio() {
      if (audioPlaying) {
        bgMusic.pause();
        audioIcon.textContent = 'üîá';
        audioControl.classList.add('muted');
        audioPlaying = false;
        localStorage.setItem('musicEnabled', 'false');
      } else {
        bgMusic.play().catch(err => {
          console.log('Autoplay bloccato dal browser:', err);
        });
        audioIcon.textContent = 'üéµ';
        audioControl.classList.remove('muted');
        audioPlaying = true;
        localStorage.setItem('musicEnabled', 'true');
      }
    }
    
    // Prova avvio automatico (potrebbe essere bloccato dal browser)
    document.addEventListener('DOMContentLoaded', () => {
      // Verifica preferenza salvata
      const musicEnabled = localStorage.getItem('musicEnabled');
      
      if (musicEnabled !== 'false') {
        // Prova autoplay (potrebbe fallire)
        bgMusic.play().then(() => {
          audioPlaying = true;
          audioIcon.textContent = 'üéµ';
          console.log('Musica avviata automaticamente');
        }).catch(() => {
          // Autoplay bloccato - mostra icona muted
          audioIcon.textContent = 'üîá';
          audioControl.classList.add('muted');
          console.log('Autoplay bloccato - click sul bottone per attivare');
        });
      } else {
        // Utente aveva disattivato la musica
        audioIcon.textContent = 'üîá';
        audioControl.classList.add('muted');
      }
    });
    
    // Volume default
    bgMusic.volume = 0.3; // 30% volume
    
    // VERSIONING AUTOMATICO - Legge versione dal service worker
    async function getAppVersion() {
      try {
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
          // Metodo 1: chiedi versione al service worker via message
          const messageChannel = new MessageChannel();
          
          navigator.serviceWorker.controller.postMessage(
            { type: 'GET_VERSION' },
            [messageChannel.port2]
          );
          
          messageChannel.port1.onmessage = (event) => {
            if (event.data && event.data.version) {
              document.getElementById('appVersion').textContent = event.data.version;
            }
          };
          
          // Timeout fallback
          setTimeout(() => {
            if (document.getElementById('appVersion').textContent === 'caricamento...') {
              document.getElementById('appVersion').textContent = '2.5';
            }
          }, 1000);
        } else {
          // Service worker non attivo, usa versione default
          document.getElementById('appVersion').textContent = '2.5';
        }
      } catch (error) {
        console.log('Errore lettura versione:', error);
        document.getElementById('appVersion').textContent = '2.5';
      }
    }
    
    // Carica versione quando service worker √® pronto
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.ready.then(() => {
        getAppVersion();
      });
    } else {
      document.getElementById('appVersion').textContent = '2.5';
    }
  </script>
</body>
</html>
