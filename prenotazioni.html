<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚öì Prenotazioni - Vecchia Dogana</title>
  
  <!-- PWA -->
  <meta name="description" content="Gestione prenotazioni Vecchia Dogana">
  <meta name="theme-color" content="#14283c">
  <link rel="manifest" href="./manifest.json">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="./icon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./icon-16x16.png">
  <link rel="apple-touch-icon" href="./icon-152x152.png">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Pirata+One&family=Rye&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Rye', serif;
      background: linear-gradient(rgba(20, 40, 60, 0.40), rgba(20, 40, 60, 0.40)), url('./SfondoVD.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: #f4e4c1;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* HEADER */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px 30px;
      background: rgba(20, 40, 60, 0.8);
      border: 3px solid #d4a574;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
    }
    
    .header h1 {
      font-family: 'Pirata One';
      font-size: 2.5em;
      color: #d4a574;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
      margin: 0;
    }
    
    .btn-home {
      background: linear-gradient(145deg, #e8b873 0%, #c89858 100%);
      color: #2c1810;
      padding: 12px 25px;
      border: 3px solid #3d1f0f;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-family: 'Rye', cursive;
      font-size: 1em;
      box-shadow: 0 4px 0 #3d1f0f;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .btn-home:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 0 #3d1f0f;
    }
    
    .btn-home:active {
      transform: translateY(0);
      box-shadow: 0 2px 0 #3d1f0f;
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      .header h1 {
        font-size: 1.8em;
      }
    }
    
    /* LAYOUT PRINCIPALE */
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
    }
    
    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }
    
    /* CALENDARIO */
    .calendario-container {
      background: rgba(244, 228, 193, 0.95);
      border: 4px solid #6b4423;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6),
                  inset 0 0 50px rgba(139, 69, 19, 0.1);
      position: relative;
    }
    
    /* Effetto pergamena */
    .calendario-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(139, 69, 19, 0.03) 2px,
          rgba(139, 69, 19, 0.03) 4px
        );
      pointer-events: none;
      border-radius: 15px;
    }
    
    .calendario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #8b4513;
    }
    
    .calendario-header h2 {
      font-family: 'Pirata One';
      font-size: 1.8em;
      color: #2c1810;
      text-shadow: 2px 2px 4px rgba(139, 69, 19, 0.3);
    }
    
    .nav-mese {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .btn-nav {
      background: linear-gradient(145deg, #6b4423 0%, #4a2f1a 100%);
      color: #f4e4c1;
      border: 2px solid #2c1810;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Pirata One';
      font-size: 1.1em;
      transition: all 0.3s;
    }
    
    .btn-nav:hover {
      background: linear-gradient(145deg, #8b5a3c 0%, #6b4423 100%);
      transform: translateY(-2px);
    }
    
    .calendario-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    
    .giorno-settimana {
      text-align: center;
      font-weight: 700;
      color: #2c1810;
      padding: 10px;
      background: rgba(139, 69, 19, 0.2);
      border-radius: 8px;
      font-size: 0.9em;
    }
    
    .giorno {
      aspect-ratio: 1;
      background: #fff;
      border: 2px solid #8b4513;
      border-radius: 10px;
      padding: 8px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    
    .giorno:hover {
      background: #fffaf0;
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(139, 69, 19, 0.3);
    }
    
    .giorno.oggi {
      background: #ffd700;
      border-color: #8b4513;
      border-width: 3px;
      font-weight: 700;
    }
    
    .giorno.altro-mese {
      opacity: 0.4;
      cursor: default;
      background: #e6d9c5;
    }
    
    .giorno.altro-mese:hover {
      transform: none;
      box-shadow: none;
    }
    
    .giorno.selezionato {
      background: #90ee90;
      border-color: #2c5f2d;
      border-width: 3px;
    }
    
    .giorno-numero {
      font-size: 1.2em;
      color: #2c1810;
      font-weight: 700;
    }
    
    .giorno-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #e74c3c;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75em;
      font-weight: 700;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    .giorno-icona {
      text-align: center;
      font-size: 1.5em;
      margin-top: 5px;
    }
    
    .giorno-tipo-badge {
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.2em;
      display: flex;
      gap: 2px;
    }
    
    .badge-prenotazione {
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
    }
    
    .badge-evento {
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
    }
    
    /* PANNELLO LATERALE */
    .pannello-laterale {
      background: rgba(20, 40, 60, 0.95);
      border: 3px solid #d4a574;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
      max-height: 800px;
      overflow-y: auto;
    }
    
    .pannello-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #d4a574;
    }
    
    .pannello-header h3 {
      font-family: 'Pirata One';
      font-size: 1.5em;
      color: #d4a574;
    }
    
    .btn-nuova {
      background: linear-gradient(145deg, #e8b873 0%, #c89858 100%);
      color: #2c1810;
      border: 2px solid #6b4423;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Pirata One';
      font-size: 1.1em;
      transition: all 0.3s;
    }
    
    .btn-nuova:hover {
      background: linear-gradient(145deg, #f0c890 0%, #d4a574 100%);
      transform: translateY(-2px);
    }
    
    /* CARD PRENOTAZIONE */
    .prenotazione-card {
      background: linear-gradient(145deg, #f4e4c1 0%, #e6d9c5 100%);
      border: 3px solid #8b4513;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      position: relative;
    }
    
    .prenotazione-card::before {
      content: '‚öì';
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 2em;
      opacity: 0.2;
    }
    
    .prenotazione-ora {
      font-size: 1.3em;
      font-weight: 700;
      color: #2c1810;
      margin-bottom: 8px;
    }
    
    .prenotazione-cliente {
      font-size: 1.1em;
      color: #2c1810;
      margin-bottom: 5px;
    }
    
    .prenotazione-dettagli {
      font-size: 0.9em;
      color: #4a2f1a;
      margin-bottom: 5px;
    }
    
    .prenotazione-note {
      font-size: 0.85em;
      color: #6b4423;
      font-style: italic;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #8b4513;
    }
    
    .prenotazione-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 5px;
      font-size: 0.8em;
      font-weight: 700;
      margin-top: 8px;
    }
    
    .badge-confermato { background: #90ee90; color: #2c5f2d; }
    .badge-attesa { background: #ffeb3b; color: #f57f17; }
    .badge-annullato { background: #ff5252; color: #b71c1c; }
    
    .prenotazione-azioni {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    
    .btn-azione {
      flex: 1;
      padding: 8px;
      border: 2px solid;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Rye';
      font-size: 0.9em;
      transition: all 0.3s;
    }
    
    .btn-modifica {
      background: #e8b873;
      color: #2c1810;
      border-color: #6b4423;
    }
    
    .btn-modifica:hover {
      background: #f0c890;
    }
    
    .btn-elimina {
      background: #e74c3c;
      color: white;
      border-color: #c0392b;
    }
    
    .btn-elimina:hover {
      background: #c0392b;
    }
    
    /* MODAL */
    
    /* LOADING SPINNER */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #d4a574;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #d4a574;
      font-family: 'Pirata One';
      font-size: 1.5em;
      margin-top: 20px;
      text-align: center;
    }
    
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    /* FEEDBACK OTTIMISTICO */
    .prenotazione-item.deleting {
      opacity: 0.5;
      pointer-events: none;
    }
    
    .prenotazione-item.saving {
      opacity: 0.7;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: linear-gradient(145deg, #f4e4c1 0%, #e6d9c5 100%);
      border: 4px solid #6b4423;
      border-radius: 15px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    }
    
    .modal-header {
      font-family: 'Pirata One';
      font-size: 1.8em;
      color: #2c1810;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      color: #2c1810;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #8b4513;
      border-radius: 8px;
      font-family: 'Rye';
      font-size: 1em;
      background: white;
      color: #2c1810;
    }
    
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn-modal {
      flex: 1;
      padding: 12px;
      border: 2px solid;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Pirata One';
      font-size: 1.1em;
      transition: all 0.3s;
    }
    
    .btn-salva {
      background: linear-gradient(145deg, #27ae60 0%, #1e8449 100%);
      color: white;
      border-color: #1e5631;
    }
    
    .btn-salva:hover {
      background: linear-gradient(145deg, #2ecc71 0%, #27ae60 100%);
    }
    
    .btn-annulla {
      background: linear-gradient(145deg, #95a5a6 0%, #7f8c8d 100%);
      color: white;
      border-color: #5a6a6b;
    }
    
    .btn-annulla:hover {
      background: linear-gradient(145deg, #a6b4b5 0%, #95a5a6 100%);
    }
    
    .btn-modal.btn-elimina {
      background: linear-gradient(145deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border-color: #a93226;
      flex: 0 0 auto;
      min-width: 180px;
    }
    
    .btn-modal.btn-elimina:hover {
      background: linear-gradient(145deg, #ec7063 0%, #e74c3c 100%);
    }
    
    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #a67c52;
    }
    
    .empty-state-icon {
      font-size: 4em;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    .empty-state-text {
      font-size: 1.1em;
    }
    
    /* LOADING */
    .loading {
      text-align: center;
      padding: 20px;
      color: #d4a574;
    }
    
    /* CARD EVENTO NEL PANNELLO LATERALE */
    .evento-giorno-card {
      background: linear-gradient(145deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.05) 100%);
      border: 3px solid #ffd700;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(255, 215, 0, 0.2);
    }
    
    .evento-giorno-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
      border-color: #ffed4e;
    }
    
    .evento-giorno-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .evento-giorno-nome {
      font-family: 'Pirata One';
      font-size: 1.5em;
      color: #ffd700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .evento-giorno-contatore {
      background: linear-gradient(145deg, #ffd700 0%, #ffed4e 100%);
      border: 2px solid #8b4513;
      border-radius: 8px;
      padding: 8px 15px;
      color: #2c1810;
      font-weight: 700;
      font-size: 1.2em;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    .evento-giorno-descrizione {
      color: #e8b873;
      font-size: 0.9em;
      margin-bottom: 10px;
    }
    
    .evento-giorno-cta {
      color: #ffd700;
      font-size: 0.9em;
      font-weight: 600;
      text-align: right;
    }
    
    /* SEZIONE HEADER */
    .sezione-header {
      font-family: 'Pirata One';
      font-size: 1.3em;
      color: #d4a574;
      margin: 25px 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(212, 165, 116, 0.3);
    }
    
    /* PANNELLO GESTIONE EVENTO */
    .pannello-evento-gestione {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .pannello-evento-gestione.active {
      display: flex;
    }
    
    .pannello-evento-content {
      background: rgba(20, 40, 60, 0.98);
      border: 4px solid #d4a574;
      border-radius: 15px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.8);
    }
    
    .pannello-evento-header {
      background: linear-gradient(145deg, rgba(212, 165, 116, 0.2) 0%, rgba(212, 165, 116, 0.05) 100%);
      padding: 25px 30px;
      border-bottom: 3px solid #d4a574;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .pannello-evento-titolo h2 {
      font-family: 'Pirata One';
      font-size: 2em;
      color: #ffd700;
      margin: 0 0 5px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
    }
    
    .pannello-evento-titolo p {
      color: #e8b873;
      font-size: 1.1em;
      margin: 0;
    }
    
    .btn-chiudi-pannello {
      background: linear-gradient(145deg, #e8b873 0%, #c89858 100%);
      color: #2c1810;
      padding: 12px 25px;
      border: 3px solid #3d1f0f;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-family: 'Rye', cursive;
      font-size: 1em;
      box-shadow: 0 4px 0 #3d1f0f;
      transition: all 0.2s;
    }
    
    .btn-chiudi-pannello:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 0 #3d1f0f;
    }
    
    .btn-chiudi-pannello:active {
      transform: translateY(0);
      box-shadow: 0 2px 0 #3d1f0f;
    }
    
    .btn-modifica-evento {
      background: linear-gradient(145deg, rgba(232, 184, 115, 0.4) 0%, rgba(200, 152, 88, 0.4) 100%);
      color: #ffd700;
      border: 2px solid #d4a574;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Rye', cursive;
      font-size: 0.95em;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 3px 8px rgba(212, 165, 116, 0.3);
    }
    
    .btn-modifica-evento:hover {
      background: linear-gradient(145deg, rgba(255, 215, 0, 0.5) 0%, rgba(232, 184, 115, 0.5) 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(212, 165, 116, 0.5);
    }
    
    .pannello-evento-body {
      padding: 30px;
    }
    
    .contatore-evento-grande {
      background: linear-gradient(145deg, #ffd700 0%, #ffed4e 100%);
      border: 3px solid #8b4513;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(139, 69, 19, 0.4);
    }
    
    .contatore-evento-numero {
      font-family: 'Pirata One';
      font-size: 3.5em;
      color: #2c1810;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .contatore-evento-label {
      font-size: 1.3em;
      color: #2c1810;
      margin-top: 5px;
      font-weight: 600;
    }
    
    .prenotazioni-evento-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .prenotazioni-evento-header h3 {
      font-family: 'Pirata One';
      font-size: 1.5em;
      color: #d4a574;
      margin: 0;
    }
    
    /* CARD PRENOTAZIONE EVENTO (con orario arrivo + note) */
    .prenotazione-evento-card {
      background: rgba(212, 165, 116, 0.1);
      border: 2px solid #d4a574;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    
    .prenotazione-evento-card:hover {
      background: rgba(212, 165, 116, 0.2);
      transform: translateX(5px);
    }
    
    .prenotazione-evento-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .prenotazione-evento-cliente {
      font-size: 1.3em;
      font-weight: 700;
      color: #ffd700;
    }
    
    .prenotazione-evento-persone {
      background: linear-gradient(145deg, #e8b873 0%, #c89858 100%);
      color: #2c1810;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 1.1em;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .prenotazione-evento-dettagli {
      color: #e8b873;
      font-size: 1em;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .prenotazione-evento-dettagli span {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .prenotazione-evento-note {
      background: rgba(212, 165, 116, 0.1);
      border-left: 3px solid #d4a574;
      padding: 10px 15px;
      margin: 10px 0;
      color: #d4a574;
      font-size: 0.95em;
      border-radius: 5px;
    }
    
    /* TOGGLE TIPO NEL FORM */
    .form-tipo-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      background: rgba(212, 165, 116, 0.1);
      padding: 5px;
      border-radius: 10px;
      border: 2px solid #d4a574;
    }
    
    .toggle-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Rye', cursive;
      font-size: 1em;
      font-weight: 600;
      transition: all 0.3s;
      background: transparent;
      color: #d4a574;
    }
    
    .toggle-btn.active {
      background: linear-gradient(145deg, #e8b873 0%, #c89858 100%);
      color: #2c1810;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .toggle-btn:hover:not(.active) {
      background: rgba(212, 165, 116, 0.2);
    }
    
    /* RESPONSIVE */
    @media (max-width: 768px) {
      .calendario-grid {
        gap: 4px;
      }
      
      .giorno {
        padding: 4px;
      }
      
      .giorno-numero {
        font-size: 1em;
      }
      
      .giorno-icona {
        font-size: 1.2em;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .header h1 {
        font-size: 2em;
      }
    }
  </style>
</head>
<body>
  <!-- LOADING OVERLAY -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-container">
      <div class="spinner"></div>
      <div class="loading-text" id="loadingText">Caricamento...</div>
    </div>
  </div>
  
  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <h1>‚öì Registro delle Prenotazioni</h1>
      <a href="index.html" class="btn-home">üè¥‚Äç‚ò†Ô∏è Porto</a>
    </div>
    
    <div class="main-layout">
      <!-- CALENDARIO -->
      <div class="calendario-container">
        <div class="calendario-header">
          <h2 id="meseAnnoTitolo">Novembre 2024</h2>
          <div class="nav-mese">
            <button class="btn-nav" onclick="cambiaMese(-1)">‚óÑ</button>
            <button class="btn-nav" onclick="vaiOggi()">Oggi</button>
            <button class="btn-nav" onclick="cambiaMese(1)">‚ñ∫</button>
          </div>
        </div>
        
        <div class="calendario-grid">
          <!-- Giorni settimana -->
          <div class="giorno-settimana">LUN</div>
          <div class="giorno-settimana">MAR</div>
          <div class="giorno-settimana">MER</div>
          <div class="giorno-settimana">GIO</div>
          <div class="giorno-settimana">VEN</div>
          <div class="giorno-settimana">SAB</div>
          <div class="giorno-settimana">DOM</div>
        </div>
        
        <div class="calendario-grid" id="giorniContainer">
          <!-- Giorni generati dinamicamente -->
        </div>
      </div>
      
      <!-- PANNELLO LATERALE -->
      <div class="pannello-laterale">
        <div class="pannello-header">
          <h3 id="pannelloTitolo">Seleziona un giorno</h3>
          <button class="btn-nuova" onclick="mostraModalNuova()" id="btnNuova" style="display:none;">‚ûï</button>
        </div>
        
        <div id="prenotazioniContainer">
          <div class="empty-state">
            <div class="empty-state-icon">üó∫Ô∏è</div>
            <div class="empty-state-text">
              Clicca su un giorno per vedere le prenotazioni
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- MODAL NUOVA/MODIFICA PRENOTAZIONE/EVENTO -->
  <div id="modalPrenotazione" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitolo">üìù Nuova Prenotazione</div>
      
      <!-- TOGGLE TIPO (solo in modalit√† cre azione) -->
      <div class="form-tipo-toggle" id="tipoToggle" style="display:none;">
        <button type="button" class="toggle-btn active" id="btnTipoPrenotazione" onclick="cambioTipo('prenotazione')">üìù Prenotazione</button>
        <button type="button" class="toggle-btn" id="btnTipoEvento" onclick="cambioTipo('evento')">üç∑ Evento</button>
      </div>
      
      <!-- CAMPI EVENTO (nascosti di default) -->
      <div id="campiEvento" style="display:none;">
        <div class="form-group">
          <label>Nome Evento *</label>
          <input type="text" id="inputNomeEvento" placeholder="es: Degustazione Vini del Territorio">
        </div>
        
        <div class="form-group">
          <label>Descrizione Evento</label>
          <textarea id="inputDescrizioneEvento" placeholder="Dettagli evento, orari, info..." rows="3"></textarea>
        </div>
      </div>
      
      <!-- CAMPI PRENOTAZIONE (visibili di default) -->
      <div id="campiPrenotazione">
        <div class="form-group">
          <label>Data *</label>
          <input type="date" id="inputData" required>
        </div>
        
        <div class="form-group" id="campoOra">
          <label>Ora</label>
          <input type="time" id="inputOra" value="19:00">
        </div>
        
        <!-- CAMPO ORARIO ARRIVO (solo per prenotazioni evento) -->
        <div class="form-group" id="campoOrarioArrivo" style="display:none;">
          <label>Orario Arrivo (opzionale)</label>
          <input type="time" id="inputOrarioArrivo" placeholder="es: 19:30">
        </div>
        
        <div class="form-group" id="campoCliente">
          <label id="labelCliente">Cliente *</label>
          <input type="text" id="inputCliente" placeholder="Nome cliente o gruppo" required>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Telefono</label>
            <input type="tel" id="inputTelefono" placeholder="123456789">
          </div>
          
          <div class="form-group">
            <label>Persone</label>
            <input type="number" id="inputPersone" min="1" value="2">
          </div>
        </div>
        
        <div class="form-group">
          <label>Note / Preferenze</label>
          <textarea id="inputNote" placeholder="Allergie, richieste speciali, ecc..."></textarea>
        </div>
        
        <div class="form-group" id="campoStato">
          <label>Stato</label>
          <select id="inputStato">
            <option value="confermato">‚úÖ Confermato</option>
            <option value="attesa">‚è≥ In attesa</option>
            <option value="annullato">‚ùå Annullato</option>
          </select>
        </div>
      </div>
      
      <div class="modal-buttons">
        <button class="btn-modal btn-annulla" onclick="chiudiModal()">‚úï Annulla</button>
        <button class="btn-modal btn-salva" onclick="salvaPrenotazioneEvento()" id="btnSalva">üíæ Salva</button>
      </div>
      
      <!-- Pulsante Crea Evento -->
      <div id="linkCreaEvento" style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(107, 68, 35, 0.3);">
        <button onclick="switchToEventoForm()" style="
          background: linear-gradient(145deg, rgba(232, 184, 115, 0.3) 0%, rgba(200, 152, 88, 0.3) 100%);
          color: #ffd700;
          border: 2px solid #d4a574;
          padding: 12px 25px;
          border-radius: 8px;
          cursor: pointer;
          font-family: 'Rye', cursive;
          font-size: 1em;
          font-weight: 600;
          transition: all 0.3s;
          box-shadow: 0 3px 8px rgba(212, 165, 116, 0.3);
          width: 100%;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 12px rgba(212, 165, 116, 0.5)'"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 8px rgba(212, 165, 116, 0.3)'">
          üç∑ Crea Evento/Degustazione
        </button>
      </div>
    </div>
  </div>
  
  <!-- PANNELLO GESTIONE EVENTO -->
  <div id="pannelloEventoGestione" class="pannello-evento-gestione">
    <div class="pannello-evento-content">
      <div class="pannello-evento-header">
        <div class="pannello-evento-titolo">
          <h2 id="eventoGestioneNome">Nome Evento</h2>
          <p id="eventoGestioneData">Data</p>
          <p id="eventoGestioneDescrizione" style="color: #d4a574; margin-top: 10px;"></p>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
          <button class="btn-modifica-evento" onclick="apriModalModificaEvento()" title="Modifica Evento">
            ‚úèÔ∏è Modifica Evento
          </button>
          <button class="btn-chiudi-pannello" onclick="chiudiPannelloEvento()">‚óÑ Torna al Giorno</button>
        </div>
      </div>
      
      <div class="pannello-evento-body">
        <div class="contatore-evento-grande">
          <div class="contatore-evento-numero" id="eventoContatoreNumero">0</div>
          <div class="contatore-evento-label">üë• Persone Confermate</div>
        </div>
        
        <div class="prenotazioni-evento-header">
          <h3>Prenotazioni Evento</h3>
          <button class="btn-nuova" onclick="mostraModalPrenotazioneEvento()">‚ûï Aggiungi</button>
        </div>
        
        <div id="prenotazioniEventoContainer">
          <!-- Prenotazioni generate dinamicamente -->
        </div>
      </div>
    </div>
  </div>
  
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzcpybXvlL5Ge24NztvVL3Kz8Jhd3jRHWH0KZmZgKW9577DIqsvXUH7h2lN4ZkzldHisQ/exec';
    
    let meseCorrente = new Date().getMonth();
    let annoCorrente = new Date().getFullYear();
    let giornoSelezionato = null;
    let prenotazioni = [];
    let modalitaModifica = false;
    let idPrenotazioneModifica = null;
    
    // Gestione Eventi Integrati
    let eventi = [];
    let eventoCorrente = null;
    let tipoCorrente = 'prenotazione'; // 'prenotazione' o 'evento'
    
    const MESI = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                  'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
    
    // Funzioni loading
    function showLoading(message = 'Caricamento...') {
      const overlay = document.getElementById('loadingOverlay');
      const text = document.getElementById('loadingText');
      text.textContent = message;
      overlay.classList.add('active');
    }
    
    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.classList.remove('active');
    }
    
    // Inizializzazione
    document.addEventListener('DOMContentLoaded', () => {
      generaCalendario();
      caricaPrenotazioni();
    });
    
    async function callAPI(action, data = {}) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          redirect: 'follow',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: action, ...data })
        });
        
        const text = await response.text();
        return JSON.parse(text);
      } catch (error) {
        console.error('Errore API:', error);
        return { errore: error.message };
      }
    }
    
    function generaCalendario() {
      const container = document.getElementById('giorniContainer');
      container.innerHTML = '';
      
      const titolo = document.getElementById('meseAnnoTitolo');
      titolo.textContent = `${MESI[meseCorrente]} ${annoCorrente}`;
      
      // Primo giorno del mese
      const primoGiorno = new Date(annoCorrente, meseCorrente, 1);
      let giornoSettimana = primoGiorno.getDay();
      giornoSettimana = giornoSettimana === 0 ? 6 : giornoSettimana - 1; // Luned√¨ = 0
      
      // Ultimo giorno del mese
      const ultimoGiorno = new Date(annoCorrente, meseCorrente + 1, 0).getDate();
      
      // Giorni del mese precedente
      const ultimoGiornoMesePrecedente = new Date(annoCorrente, meseCorrente, 0).getDate();
      for (let i = giornoSettimana - 1; i >= 0; i--) {
        const giorno = ultimoGiornoMesePrecedente - i;
        container.innerHTML += `
          <div class="giorno altro-mese">
            <div class="giorno-numero">${giorno}</div>
          </div>
        `;
      }
      
      // Giorni del mese corrente
      const oggi = new Date();
      const oggiStr = `${oggi.getFullYear()}-${String(oggi.getMonth() + 1).padStart(2, '0')}-${String(oggi.getDate()).padStart(2, '0')}`;
      
      for (let giorno = 1; giorno <= ultimoGiorno; giorno++) {
        const dataStr = `${annoCorrente}-${String(meseCorrente + 1).padStart(2, '0')}-${String(giorno).padStart(2, '0')}`;
        const isOggi = dataStr === oggiStr;
        const isSelezionato = giornoSelezionato === dataStr;
        
        // Prenotazioni normali (senza evento_id)
        const prenotazioniNormali = prenotazioni.filter(p => p.data === dataStr && !p.evento_id);
        const numPrenotazioni = prenotazioniNormali.length;
        
        // Eventi in questo giorno
        const eventiGiorno = eventi.filter(e => e.data === dataStr);
        const hasEvento = eventiGiorno.length > 0;
        
        let classi = 'giorno';
        if (isOggi) classi += ' oggi';
        if (isSelezionato) classi += ' selezionato';
        
        // Badge tipo (prenotazioni e/o eventi)
        let badgeTipo = '';
        if (hasEvento && numPrenotazioni > 0) {
          badgeTipo = '<div class="giorno-tipo-badge"><span class="badge-prenotazione">‚öì</span><span class="badge-evento">üç∑</span></div>';
        } else if (hasEvento) {
          badgeTipo = '<div class="giorno-tipo-badge"><span class="badge-evento">üç∑</span></div>';
        } else if (numPrenotazioni > 0) {
          badgeTipo = '<div class="giorno-tipo-badge"><span class="badge-prenotazione">‚öì</span></div>';
        }
        
        // Badge numero prenotazioni
        const totaleGiorno = numPrenotazioni + (hasEvento ? 1 : 0);
        const badgeNumero = totaleGiorno > 0 ? `<div class="giorno-badge">${totaleGiorno}</div>` : '';
        
        container.innerHTML += `
          <div class="${classi}" onclick="selezionaGiorno('${dataStr}')">
            <div class="giorno-numero">${giorno}</div>
            ${badgeNumero}
            ${badgeTipo}
          </div>
        `;
      }
      
      // Giorni del mese successivo
      const giorniRimanenti = 42 - (giornoSettimana + ultimoGiorno);
      for (let giorno = 1; giorno <= giorniRimanenti; giorno++) {
        container.innerHTML += `
          <div class="giorno altro-mese">
            <div class="giorno-numero">${giorno}</div>
          </div>
        `;
      }
    }
    
    async function caricaPrenotazioni() {
      try {
        // Carica prenotazioni
        const resultPren = await callAPI('getPrenotazioni', {
          anno: annoCorrente,
          mese: meseCorrente + 1
        });
        
        if (resultPren.prenotazioni) {
          prenotazioni = resultPren.prenotazioni;
        } else if (resultPren.errore) {
          console.error('Errore API prenotazioni:', resultPren.errore);
          prenotazioni = [];
        }
        
        // Carica eventi
        const resultEventi = await callAPI('getEventi');
        if (resultEventi.eventi) {
          eventi = resultEventi.eventi;
        } else if (resultEventi.errore) {
          console.error('Errore API eventi:', resultEventi.errore);
          eventi = [];
        }
      } catch (error) {
        console.error('Errore caricamento:', error);
        prenotazioni = [];
        eventi = [];
      }
      
      // Genera calendario comunque (anche se vuoto)
      generaCalendario();
      
      if (giornoSelezionato) {
        mostraPrenotazioniGiorno(giornoSelezionato);
      }
    }
    
    function selezionaGiorno(dataStr) {
      giornoSelezionato = dataStr;
      generaCalendario();
      mostraPrenotazioniGiorno(dataStr);
    }
    
    function mostraPrenotazioniGiorno(dataStr) {
      // Filtra prenotazioni normali (senza evento_id) e eventi del giorno
      const prenotazioniNormali = prenotazioni.filter(p => p.data === dataStr && !p.evento_id);
      const eventiGiorno = eventi.filter(e => e.data === dataStr);
      
      const [anno, mese, giorno] = dataStr.split('-');
      const data = new Date(anno, mese - 1, giorno);
      const nomeGiorno = data.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
      
      document.getElementById('pannelloTitolo').textContent = nomeGiorno.charAt(0).toUpperCase() + nomeGiorno.slice(1);
      document.getElementById('btnNuova').style.display = 'block';
      
      const container = document.getElementById('prenotazioniContainer');
      
      // Se non ci sono n√© eventi n√© prenotazioni
      if (eventiGiorno.length === 0 && prenotazioniNormali.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üèùÔ∏è</div>
            <div class="empty-state-text">
              Nessuna prenotazione per questo giorno
            </div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      
      // MOSTRA EVENTI (se presenti)
      if (eventiGiorno.length > 0) {
        eventiGiorno.forEach(evento => {
          // Conta prenotazioni per questo evento
          const prenotazioniEvento = prenotazioni.filter(p => p.evento_id === evento.id && p.stato !== 'annullato');
          const totalePersone = prenotazioniEvento.reduce((sum, p) => sum + (parseInt(p.persone) || 0), 0);
          
          container.innerHTML += `
            <div class="evento-giorno-card" onclick="apriGestioneEvento('${evento.id}')">
              <div class="evento-giorno-header">
                <div class="evento-giorno-nome">üç∑ ${evento.nome}</div>
                <div class="evento-giorno-contatore">${totalePersone} üë•</div>
              </div>
              ${evento.descrizione ? `<div class="evento-giorno-descrizione">${evento.descrizione}</div>` : ''}
              <div class="evento-giorno-cta">Click per gestire ‚Üí</div>
            </div>
          `;
        });
      }
      
      // MOSTRA PRENOTAZIONI NORMALI (se presenti)
      if (prenotazioniNormali.length > 0) {
        if (eventiGiorno.length > 0) {
          container.innerHTML += '<div class="sezione-header">‚öì Prenotazioni</div>';
        }
        
        prenotazioniNormali.forEach(pren => {
          const badgeClass = `badge-${pren.stato}`;
          container.innerHTML += `
            <div class="prenotazione-card">
              <div class="prenotazione-ora">üïê ${pren.ora || 'Orario da definire'}</div>
              <div class="prenotazione-cliente">üë§ ${pren.cliente}</div>
              ${pren.telefono ? `<div class="prenotazione-dettagli">üìû ${pren.telefono}</div>` : ''}
              ${pren.persone ? `<div class="prenotazione-dettagli">üë• ${pren.persone} ${pren.persone === 1 ? 'persona' : 'persone'}</div>` : ''}
              ${pren.note ? `<div class="prenotazione-note">üìù ${pren.note}</div>` : ''}
              <span class="prenotazione-badge ${badgeClass}">
                ${pren.stato === 'confermato' ? '‚úÖ Confermato' : pren.stato === 'attesa' ? '‚è≥ In attesa' : '‚ùå Annullato'}
              </span>
              <div class="prenotazione-azioni">
                <button class="btn-azione btn-modifica" onclick="modificaPrenotazione('${pren.id}')">‚úèÔ∏è Modifica</button>
                <button class="btn-azione btn-elimina" onclick="eliminaPrenotazione('${pren.id}')">üóëÔ∏è Elimina</button>
              </div>
            </div>
          `;
        });
      }
    }
    
    function cambiaMese(delta) {
      meseCorrente += delta;
      if (meseCorrente > 11) {
        meseCorrente = 0;
        annoCorrente++;
      } else if (meseCorrente < 0) {
        meseCorrente = 11;
        annoCorrente--;
      }
      giornoSelezionato = null;
      caricaPrenotazioni();
    }
    
    function vaiOggi() {
      const oggi = new Date();
      meseCorrente = oggi.getMonth();
      annoCorrente = oggi.getFullYear();
      const oggiStr = `${oggi.getFullYear()}-${String(oggi.getMonth() + 1).padStart(2, '0')}-${String(oggi.getDate()).padStart(2, '0')}`;
      giornoSelezionato = oggiStr;
      caricaPrenotazioni();
    }
    
    function mostraModalNuova() {
      modalitaModifica = false;
      tipoCorrente = 'prenotazione';
      
      document.getElementById('modalTitolo').textContent = 'üìù Nuova Prenotazione';
      document.getElementById('inputData').value = giornoSelezionato;
      document.getElementById('inputOra').value = '19:00';
      document.getElementById('inputCliente').value = '';
      document.getElementById('inputTelefono').value = '';
      document.getElementById('inputPersone').value = '2';
      document.getElementById('inputNote').value = '';
      document.getElementById('inputStato').value = 'confermato';
      
      // Reset campi evento
      document.getElementById('inputNomeEvento').value = '';
      document.getElementById('inputDescrizioneEvento').value = '';
      
      // Mostra prenotazione, nascondi evento
      document.getElementById('campiEvento').style.display = 'none';
      document.getElementById('campiPrenotazione').style.display = 'block';
      document.getElementById('linkCreaEvento').style.display = 'block';
      document.getElementById('tipoToggle').style.display = 'none';
      document.getElementById('btnSalva').textContent = 'üíæ Salva';
      
      document.getElementById('modalPrenotazione').classList.add('active');
    }
    
    function modificaPrenotazione(id) {
      const pren = prenotazioni.find(p => p.id === id);
      if (!pren) return;
      
      modalitaModifica = true;
      idPrenotazioneModifica = id;
      tipoCorrente = 'prenotazione';
      
      document.getElementById('modalTitolo').textContent = '‚úèÔ∏è Modifica Prenotazione';
      document.getElementById('inputData').value = pren.data;
      document.getElementById('inputOra').value = pren.ora || '19:00';
      document.getElementById('inputCliente').value = pren.cliente;
      document.getElementById('inputTelefono').value = pren.telefono || '';
      document.getElementById('inputPersone').value = pren.persone || 2;
      document.getElementById('inputNote').value = pren.note || '';
      document.getElementById('inputStato').value = pren.stato;
      
      // Nascondi link evento e mostra solo campi prenotazione
      document.getElementById('campiEvento').style.display = 'none';
      document.getElementById('campiPrenotazione').style.display = 'block';
      document.getElementById('linkCreaEvento').style.display = 'none';
      document.getElementById('tipoToggle').style.display = 'none';
      document.getElementById('btnSalva').textContent = 'üíæ Salva';
      
      document.getElementById('modalPrenotazione').classList.add('active');
    }
    
    
    async function eliminaPrenotazione(id) {
      if (!confirm('üóëÔ∏è Sei sicuro di voler eliminare questa prenotazione?')) {
        return;
      }
      
      showLoading('Eliminazione...');
      
      try {
        const result = await callAPI('eliminaPrenotazione', { id: id });
        
        if (result.successo) {
          await caricaPrenotazioni();
          
          // Se siamo in gestione evento, riapri evento
          if (eventoCorrente) {
            await apriGestioneEvento(eventoCorrente.id);
          } else if (giornoSelezionato) {
            mostraPrenotazioniGiorno(giornoSelezionato);
          }
          
          hideLoading();
          alert(`‚úÖ ${result.messaggio}`);
        } else {
          hideLoading();
          alert(`‚ö†Ô∏è Errore: ${result.errore}`);
        }
      } catch (error) {
        hideLoading();
        alert('‚ùå Errore: ' + error.message);
      }
    }
    
    function chiudiModal() {
      document.getElementById('modalPrenotazione').classList.remove('active');
      // Reset modal a stato prenotazione
      tipoCorrente = 'prenotazione';
      modalitaModifica = false;
      document.getElementById('campiEvento').style.display = 'none';
      document.getElementById('campiPrenotazione').style.display = 'block';
      document.getElementById('linkCreaEvento').style.display = 'block';
      document.getElementById('tipoToggle').style.display = 'none';
      
      // Nascondi pulsante elimina evento se esiste
      const btnElimina = document.getElementById('btnEliminaEvento');
      if (btnElimina) {
        btnElimina.style.display = 'none';
      }
    }
    
    // ========== GESTIONE TIPO NEL MODAL ==========
    function switchToEvento() {
      tipoCorrente = 'evento';
      document.getElementById('modalTitolo').textContent = 'üç∑ Nuovo Evento';
      document.getElementById('campiEvento').style.display = 'block';
      document.getElementById('campiPrenotazione').style.display = 'none';
      document.getElementById('linkCreaEvento').style.display = 'none';
      document.getElementById('btnSalva').textContent = 'üíæ Crea Evento';
      
      // Mantieni data selezionata
      document.getElementById('inputData').value = giornoSelezionato;
    }
    
    function cambioTipo(tipo) {
      tipoCorrente = tipo;
      
      if (tipo === 'evento') {
        document.getElementById('btnTipoEvento').classList.add('active');
        document.getElementById('btnTipoPrenotazione').classList.remove('active');
        document.getElementById('modalTitolo').textContent = 'üç∑ Nuovo Evento';
        document.getElementById('campiEvento').style.display = 'block';
        document.getElementById('campoOra').style.display = 'none';
        document.getElementById('campoOrarioArrivo').style.display = 'none';
        document.getElementById('campoCliente').style.display = 'none';
        document.getElementById('campoStato').style.display = 'none';
        document.getElementById('btnSalva').textContent = 'üíæ Crea Evento';
      } else {
        document.getElementById('btnTipoPrenotazione').classList.add('active');
        document.getElementById('btnTipoEvento').classList.remove('active');
        document.getElementById('modalTitolo').textContent = 'üìù Nuova Prenotazione';
        document.getElementById('campiEvento').style.display = 'none';
        document.getElementById('campoOra').style.display = 'block';
        document.getElementById('campoOrarioArrivo').style.display = 'none';
        document.getElementById('campoCliente').style.display = 'block';
        document.getElementById('campoStato').style.display = 'block';
        document.getElementById('btnSalva').textContent = 'üíæ Salva';
      }
    }
    
    // ========== GESTIONE EVENTI ==========
    async function apriGestioneEvento(id) {
      eventoCorrente = eventi.find(e => e.id === id);
      if (!eventoCorrente) return;
      
      // Aggiorna header pannello
      const dataObj = new Date(eventoCorrente.data + 'T00:00:00');
      const dataFormattata = dataObj.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      
      document.getElementById('eventoGestioneNome').textContent = eventoCorrente.nome;
      document.getElementById('eventoGestioneData').textContent = 'üìÖ ' + dataFormattata;
      document.getElementById('eventoGestioneDescrizione').textContent = eventoCorrente.descrizione || '';
      document.getElementById('eventoGestioneDescrizione').style.display = eventoCorrente.descrizione ? 'block' : 'none';
      
      // Carica prenotazioni evento
      const prenotazioniEvento = prenotazioni.filter(p => p.evento_id === id);
      const totalePersone = prenotazioniEvento.filter(p => p.stato !== 'annullato').reduce((sum, p) => sum + (parseInt(p.persone) || 0), 0);
      
      document.getElementById('eventoContatoreNumero').textContent = totalePersone;
      
      mostraPrenotazioniEvento(prenotazioniEvento);
      
      // Mostra pannello
      document.getElementById('pannelloEventoGestione').classList.add('active');
    }
    
    function mostraPrenotazioniEvento(prenotazioniEvento) {
      const container = document.getElementById('prenotazioniEventoContainer');
      
      if (prenotazioniEvento.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üèùÔ∏è</div>
            <div class="empty-state-text">
              Nessuna prenotazione per questo evento
            </div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      prenotazioniEvento.forEach(pren => {
        const badgeClass = `badge-${pren.stato}`;
        const persone = parseInt(pren.persone) || 0;
        
        let dettagliHtml = '<div class="prenotazione-evento-dettagli">';
        if (pren.ora) {
          dettagliHtml += `<span>üïê ${pren.ora}</span>`;
        }
        if (pren.telefono) {
          dettagliHtml += `<span>üìû ${pren.telefono}</span>`;
        }
        dettagliHtml += `<span class="${badgeClass}">${pren.stato === 'confermato' ? '‚úÖ Confermato' : pren.stato === 'attesa' ? '‚è≥ In attesa' : '‚ùå Annullato'}</span>`;
        dettagliHtml += '</div>';
        
        container.innerHTML += `
          <div class="prenotazione-evento-card">
            <div class="prenotazione-evento-top">
              <div class="prenotazione-evento-cliente">üë§ ${pren.cliente}</div>
              <div class="prenotazione-evento-persone">${persone} üë•</div>
            </div>
            ${dettagliHtml}
            ${pren.note ? `<div class="prenotazione-evento-note">üìù ${pren.note}</div>` : ''}
            <div class="prenotazione-azioni" style="margin-top: 12px;">
              <button class="btn-azione btn-modifica" onclick="modificaPrenotazioneEvento('${pren.id}')">‚úèÔ∏è Modifica</button>
              <button class="btn-azione btn-elimina" onclick="eliminaPrenotazione('${pren.id}')">üóëÔ∏è Elimina</button>
            </div>
          </div>
        `;
      });
    }
    
    function chiudiPannelloEvento() {
      document.getElementById('pannelloEventoGestione').classList.remove('active');
      eventoCorrente = null;
      caricaPrenotazioni(); // Ricarica per aggiornare contatori nel pannello laterale
    }
    
    function mostraModalPrenotazioneEvento() {
      modalitaModifica = false;
      tipoCorrente = 'prenotazione';
      
      document.getElementById('modalTitolo').textContent = '‚ûï Nuova Prenotazione Evento';
      document.getElementById('inputData').value = eventoCorrente.data;
      document.getElementById('inputOra').value = '';
      document.getElementById('inputCliente').value = '';
      document.getElementById('inputTelefono').value = '';
      document.getElementById('inputPersone').value = '2';
      document.getElementById('inputNote').value = '';
      document.getElementById('inputStato').value = 'confermato';
      
      // Mostra solo campi prenotazione (no evento)
      document.getElementById('campiEvento').style.display = 'none';
      document.getElementById('campiPrenotazione').style.display = 'block';
      document.getElementById('linkCreaEvento').style.display = 'none';
      document.getElementById('tipoToggle').style.display = 'none';
      document.getElementById('btnSalva').textContent = 'üíæ Salva';
      
      document.getElementById('modalPrenotazione').classList.add('active');
    }
    
    function modificaPrenotazioneEvento(id) {
      const pren = prenotazioni.find(p => p.id === id);
      if (!pren) return;
      
      modalitaModifica = true;
      idPrenotazioneModifica = id;
      tipoCorrente = 'prenotazione';
      
      document.getElementById('modalTitolo').textContent = '‚úèÔ∏è Modifica Prenotazione';
      document.getElementById('inputData').value = pren.data;
      document.getElementById('inputOra').value = pren.ora || '';
      document.getElementById('inputCliente').value = pren.cliente;
      document.getElementById('inputTelefono').value = pren.telefono || '';
      document.getElementById('inputPersone').value = pren.persone || '2';
      document.getElementById('inputNote').value = pren.note || '';
      document.getElementById('inputStato').value = pren.stato;
      
      document.getElementById('campiEvento').style.display = 'none';
      document.getElementById('campiPrenotazione').style.display = 'block';
      document.getElementById('linkCreaEvento').style.display = 'none';
      document.getElementById('tipoToggle').style.display = 'none';
      document.getElementById('btnSalva').textContent = 'üíæ Salva';
      
      document.getElementById('modalPrenotazione').classList.add('active');
    }
    
    async function salvaPrenotazioneEvento() {
      if (tipoCorrente === 'evento') {
        // Salva o modifica evento
        const nome = document.getElementById('inputNomeEvento').value.trim();
        const data = document.getElementById('inputData').value;
        const descrizione = document.getElementById('inputDescrizioneEvento').value.trim();
        
        if (!nome || !data) {
          alert('‚ö†Ô∏è Nome e data evento sono obbligatori!');
          return;
        }
        
        if (modalitaModifica && eventoCorrente) {
          // Modifica evento esistente
          await modificaEvento();
        } else {
          // Crea nuovo evento
          showLoading('Creazione evento...');
          
          const result = await callAPI('creaEvento', {
            nome: nome,
            data: data,
            descrizione: descrizione
          });
          
          hideLoading();
          
          if (result.errore) {
            alert('Errore: ' + result.errore);
            return;
          }
          
          chiudiModal();
          await caricaPrenotazioni();
          alert('‚úÖ Evento creato!');
        }
        
      } else {
        // Salva prenotazione
        const prenotazione = {
          data: document.getElementById('inputData').value,
          ora: document.getElementById('inputOra').value,
          cliente: document.getElementById('inputCliente').value,
          telefono: document.getElementById('inputTelefono').value,
          persone: parseInt(document.getElementById('inputPersone').value) || 0,
          note: document.getElementById('inputNote').value,
          stato: document.getElementById('inputStato').value
        };
        
        // Aggiungi evento_id se siamo in gestione evento
        if (eventoCorrente) {
          prenotazione.evento_id = eventoCorrente.id;
        }
        
        if (!prenotazione.data || !prenotazione.cliente) {
          alert('‚ö†Ô∏è Data e Cliente sono obbligatori!');
          return;
        }
        
        showLoading(modalitaModifica ? 'Aggiornamento...' : 'Salvataggio...');
        
        let result;
        if (modalitaModifica) {
          result = await callAPI('modificaPrenotazione', {
            id: idPrenotazioneModifica,
            prenotazione: prenotazione
          });
        } else {
          result = await callAPI('salvaPrenotazione', {
            prenotazione: prenotazione
          });
        }
        
        hideLoading();
        
        if (result.errore) {
          alert('Errore: ' + result.errore);
          return;
        }
        
        chiudiModal();
        
        // Se siamo in gestione evento, riapri evento
        if (eventoCorrente) {
          await caricaPrenotazioni();
          await apriGestioneEvento(eventoCorrente.id);
        } else {
          await caricaPrenotazioni();
          if (giornoSelezionato) {
            mostraPrenotazioniGiorno(giornoSelezionato);
          }
        }
        
        alert(`‚úÖ ${result.messaggio || 'Salvato!'}`);
      }
    }
    
    // ========== MODIFICA EVENTO ==========
    function apriModalModificaEvento() {
      if (!eventoCorrente) return;
      
      modalitaModifica = true;
      tipoCorrente = 'evento';
      
      document.getElementById('modalTitolo').textContent = '‚úèÔ∏è Modifica Evento';
      document.getElementById('inputNomeEvento').value = eventoCorrente.nome;
      document.getElementById('inputData').value = eventoCorrente.data;
      document.getElementById('inputDescrizioneEvento').value = eventoCorrente.descrizione || '';
      
      // Mostra campi evento
      document.getElementById('campiEvento').style.display = 'block';
      document.getElementById('campiPrenotazione').style.display = 'none';
      document.getElementById('linkCreaEvento').style.display = 'none';
      document.getElementById('tipoToggle').style.display = 'none';
      document.getElementById('btnSalva').textContent = 'üíæ Salva Modifiche';
      
      // Aggiungi pulsante elimina se non esiste
      let btnElimina = document.getElementById('btnEliminaEvento');
      if (!btnElimina) {
        btnElimina = document.createElement('button');
        btnElimina.id = 'btnEliminaEvento';
        btnElimina.className = 'btn-modal btn-elimina';
        btnElimina.textContent = 'üóëÔ∏è Elimina Evento';
        btnElimina.onclick = confermaEliminaEvento;
        btnElimina.style.marginRight = 'auto';
        document.querySelector('.modal-buttons').insertBefore(btnElimina, document.querySelector('.modal-buttons').firstChild);
      }
      btnElimina.style.display = 'block';
      
      document.getElementById('modalPrenotazione').classList.add('active');
    }
    
    async function modificaEvento() {
      const nome = document.getElementById('inputNomeEvento').value.trim();
      const data = document.getElementById('inputData').value;
      const descrizione = document.getElementById('inputDescrizioneEvento').value.trim();
      
      if (!nome || !data) {
        alert('‚ö†Ô∏è Nome e data evento sono obbligatori!');
        return;
      }
      
      if (!eventoCorrente) return;
      
      showLoading('Aggiornamento evento...');
      
      const result = await callAPI('modificaEvento', {
        id: eventoCorrente.id,
        nome: nome,
        data: data,
        descrizione: descrizione
      });
      
      hideLoading();
      
      if (result.errore) {
        alert('Errore: ' + result.errore);
        return;
      }
      
      chiudiModal();
      await caricaPrenotazioni();
      
      // Riapri evento modificato
      const eventoAggiornato = eventi.find(e => e.id === eventoCorrente.id);
      if (eventoAggiornato) {
        await apriGestioneEvento(eventoAggiornato.id);
      }
      
      alert('‚úÖ Evento modificato!');
    }
    
    function confermaEliminaEvento() {
      if (!eventoCorrente) return;
      
      const conferma = confirm(
        `‚ö†Ô∏è ATTENZIONE!\n\n` +
        `Stai per eliminare l'evento "${eventoCorrente.nome}".\n\n` +
        `Verranno eliminate TUTTE le prenotazioni associate a questo evento.\n\n` +
        `Confermi l'eliminazione?`
      );
      
      if (conferma) {
        eliminaEvento();
      }
    }
    
    async function eliminaEvento() {
      if (!eventoCorrente) return;
      
      showLoading('Eliminazione evento...');
      
      const result = await callAPI('eliminaEvento', {
        id: eventoCorrente.id
      });
      
      hideLoading();
      
      if (result.errore) {
        alert('Errore: ' + result.errore);
        return;
      }
      
      chiudiModal();
      chiudiPannelloEvento();
      await caricaPrenotazioni();
      
      alert('‚úÖ Evento eliminato!');
    }
    
    // Service Worker per PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js');
    }
  </script>
</body>
</html>
