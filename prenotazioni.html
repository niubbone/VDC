<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prenotazioni - Vecchia Dogana</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#8b4513">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Prenotazioni VDC">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(rgba(244, 228, 193, 0.15), rgba(230, 217, 197, 0.15)), url('./SfondoVD.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh;
      padding: 20px;
      color: #2c1810;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* HEADER CON ANCORA */
    .header-container {
      max-width: 1400px;
      margin: 0 auto 25px auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 30px;
      background: #8A9AA6;
      border: 3px solid #f4e4c1;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(107, 68, 35, 0.25);
    }
    
    .header-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .header-anchor {
      font-size: 2.5em;
      filter: drop-shadow(2px 2px 4px rgba(44, 24, 16, 0.3));
      color: #f4e4c1;
    }
    
    .header h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2em;
      font-weight: 700;
      color: #f4e4c1;
      margin: 0;
      letter-spacing: -0.01em;
      text-shadow: 2px 2px 4px rgba(44, 24, 16, 0.3);
    }
    
    .btn-back {
      background: linear-gradient(135deg, #f4e4c1 0%, #e6d9c5 100%);
      color: #6b4423;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      font-size: 1.8em;
      box-shadow: 0 3px 10px rgba(107, 68, 35, 0.3);
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 42px;
      line-height: 1;
      text-shadow: 1px 1px 2px rgba(44, 24, 16, 0.15);
    }
    
    .btn-back:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(200, 152, 88, 0.4);
    }
    
    .btn-back:active {
      transform: translateY(0);
    }
    
    .calendario-container {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
    }
    
    @media (max-width: 968px) {
      .calendario-container {
        grid-template-columns: 1fr;
      }
      
      .header {
        padding: 15px 20px;
      }
      
      .header h1 {
        font-size: 1.5em;
      }
      
      .header-anchor {
        font-size: 2em;
      }
      
      .btn-back {
        font-size: 1.5em;
        padding: 6px 12px;
        min-width: 38px;
      }
      
      .pannello-laterale {
        max-height: 500px !important;
      }
    }
    
    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2em;
      font-weight: 700;
      color: #6b4423;
      margin-bottom: 25px;
      text-align: center;
      letter-spacing: -0.01em;
    }
    
    /* CALENDARIO */
    .calendario {
      background: linear-gradient(145deg, #f4e4c1 0%, #e6d9c5 100%);
      border: 3px solid #c89858;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 6px 25px rgba(107, 68, 35, 0.25);
    }
    
    .calendario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid rgba(255, 255, 255, 0.6);
    }
    
    .calendario-header h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.5em;
      font-weight: 700;
      color: #6b4423;
      text-shadow: 2px 2px 4px rgba(107, 68, 35, 0.25);
    }
    
    .calendario-nav {
      display: flex;
      gap: 10px;
    }
    
    .btn-nav {
      background: #fff;
      border: 2px solid #c89858;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.95em;
      color: #2c1810;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
      box-shadow: 0 2px 6px rgba(107, 68, 35, 0.25);
      text-shadow: 1px 1px 2px rgba(107, 68, 35, 0.15);
    }
    
    .btn-nav:hover {
      background: #c89858;
      color: #fff;
      transform: translateY(-1px);
    }
    
    .giorni-settimana {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-bottom: 6px;
    }
    
    .giorni-container {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    
    .giorno-settimana {
      text-align: center;
      font-weight: 600;
      color: #8b4513;
      padding: 10px;
      background: #faf5ef;
      border-radius: 8px;
      font-size: 0.85em;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    
    .giorno {
      aspect-ratio: 1;
      background: #faf8f3;
      border: 2px solid #e8dcc8;
      border-radius: 10px;
      padding: 8px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    
    .giorno:hover {
      background: #fff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(200, 152, 88, 0.2);
      border-color: #c89858;
    }
    
    .giorno.oggi {
      background: #fef9e7;
      border-color: #8A9AA6;
      border-width: 2px;
      font-weight: 700;
      box-shadow: 0 0 0 0.5px #8A9AA6;
    }
    
    .giorno.oggi .giorno-numero {
      color: #2c1810;
    }
    
    .giorno.domenica {
      border-color: #dc2626;
      border-width: 2px;
    }
    
    .giorno.selezionato {
      background: linear-gradient(135deg, #c7f0bd 0%, #a7dba4 100%);
      border-color: #90be6d;
      border-width: 3px;
      font-weight: 700;
    }
    
    .giorno.selezionato .giorno-numero {
      color: #2c1810;
    }
    
    .giorno.altro-mese {
      opacity: 0.3;
      cursor: default;
      background: #fafafa;
    }
    
    .giorno.altro-mese:hover {
      transform: none;
      box-shadow: none;
    }
    
    .giorno-numero {
      font-size: 1.05em;
      font-weight: 600;
      color: #2c1810;
    }
    
    .giorno-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background: linear-gradient(135deg, #e8b873 0%, #c89858 100%);
      color: #fff;
      font-size: 0.7em;
      font-weight: 700;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(200, 152, 88, 0.3);
    }
    
    .giorno-tipo-badge {
      display: flex;
      gap: 3px;
      align-items: center;
      margin-top: auto;
    }
    
    .badge-prenotazione, .badge-evento {
      font-size: 1.2em;
      filter: drop-shadow(0 1px 3px rgba(107, 68, 35, 0.2));
    }
    
    /* PANNELLO LATERALE */
    .pannello-laterale {
      background: #8A9AA6;
      border: 3px solid #f4e4c1;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 25px rgba(107, 68, 35, 0.25);
      max-height: 800px;
      overflow-y: auto;
    }
    
    .pannello-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      padding-bottom: 15px;
      border-bottom: 3px solid rgba(244, 228, 193, 0.6);
    }
    
    .pannello-header h3 {
      font-family: 'Playfair Display', serif;
      font-size: 1.25em;
      font-weight: 700;
      color: #f4e4c1;
      text-shadow: 1px 1px 3px rgba(44, 24, 16, 0.3);
    }
    
    .btn-nuova {
      background: linear-gradient(135deg, #f4e4c1 0%, #e6d9c5 100%);
      color: #6b4423;
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1.5em;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
      box-shadow: 0 3px 10px rgba(107, 68, 35, 0.3);
      text-shadow: 1px 1px 2px rgba(44, 24, 16, 0.15);
      min-width: 45px;
      line-height: 1;
    }
    
    .btn-nuova:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(200, 152, 88, 0.35);
    }
    
    /* CARD PRENOTAZIONE */
    .prenotazione-card {
      background: #faf8f3;
      border: 2px solid #e8dcc8;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }
    
    .prenotazione-card:hover {
      border-color: #c89858;
      box-shadow: 0 3px 10px rgba(200, 152, 88, 0.15);
      transform: translateX(3px);
    }
    
    .prenotazione-ora {
      font-size: 1.2em;
      font-weight: 700;
      color: #8b4513;
      margin-bottom: 6px;
    }
    
    .prenotazione-cliente {
      font-size: 1.05em;
      color: #2c1810;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .prenotazione-dettagli {
      font-size: 0.9em;
      color: #6b4423;
      margin-bottom: 5px;
    }
    
    .prenotazione-note {
      font-size: 0.85em;
      color: #8b4513;
      font-style: italic;
      background: #fff;
      border-left: 3px solid #c89858;
      padding: 8px 12px;
      margin: 8px 0;
      border-radius: 5px;
    }
    
    .prenotazione-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    
    .btn-modifica, .btn-elimina {
      padding: 7px 14px;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85em;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }
    
    .btn-modifica {
      background: #fff;
      color: #8b4513;
      border: 2px solid #e8dcc8;
    }
    
    .btn-modifica:hover {
      background: #c89858;
      color: #fff;
      border-color: #c89858;
    }
    
    .btn-elimina {
      background: #fff5f5;
      color: #d32f2f;
      border: 2px solid #ffcdd2;
    }
    
    .btn-elimina:hover {
      background: #d32f2f;
      color: #fff;
      border-color: #d32f2f;
    }
    
    /* LOADING SPINNER - FIX MOBILE */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(44, 24, 16, 0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 99999;
      /* Fix mobile */
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
    }
    
    .loading-overlay.active {
      display: flex;
      display: -webkit-flex;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(232, 184, 115, 0.3);
      border-top-color: #e8b873;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      -webkit-animation: spin 0.8s linear infinite;
      /* Fix mobile rendering */
      will-change: transform;
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @-webkit-keyframes spin {
      to { -webkit-transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #e8b873;
      font-weight: 600;
      font-size: 1.1em;
      margin-top: 20px;
      text-align: center;
    }
    
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      /* Fix mobile */
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
    }
    
    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      /* Fix mobile */
      -webkit-overflow-scrolling: touch;
    }
    
    .modal.active {
      display: flex;
      display: -webkit-flex;
    }
    
    .modal-content {
      background: #fff;
      border: 2px solid #c89858;
      border-radius: 12px;
      padding: 25px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(107, 68, 35, 0.3);
    }
    
    .modal-header {
      font-family: 'Playfair Display', serif;
      font-size: 1.5em;
      font-weight: 700;
      color: #6b4423;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #6b4423;
      font-size: 0.9em;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #e8dcc8;
      border-radius: 8px;
      font-size: 0.95em;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
      color: #2c1810;
      background: #fff;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #c89858;
      box-shadow: 0 0 0 3px rgba(200, 152, 88, 0.1);
    }
    
    textarea {
      resize: vertical;
      min-height: 70px;
    }
    
    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn-submit {
      flex: 1;
      padding: 12px;
      background: linear-gradient(135deg, #e8b873 0%, #c89858 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.95em;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
      box-shadow: 0 3px 10px rgba(200, 152, 88, 0.25);
    }
    
    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(200, 152, 88, 0.35);
    }
    
    .btn-cancel {
      flex: 1;
      padding: 12px;
      background: #fff;
      color: #6b4423;
      border: 2px solid #e8dcc8;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.95em;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }
    
    .btn-cancel:hover {
      background: #faf5ef;
      border-color: #c89858;
    }
    
    /* TOGGLE TIPO */
    .toggle-tipo {
      display: flex;
      gap: 10px;
      margin-bottom: 18px;
    }
    
    .toggle-btn {
      flex: 1;
      padding: 10px;
      background: #fff;
      border: 2px solid #e8dcc8;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      text-align: center;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
      color: #6b4423;
    }
    
    .toggle-btn.active {
      background: linear-gradient(135deg, #e8b873 0%, #c89858 100%);
      color: #fff;
      border-color: #c89858;
      box-shadow: 0 3px 10px rgba(200, 152, 88, 0.25);
    }
    
    /* PANNELLO GESTIONE EVENTO */
    .pannello-evento-gestione {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      /* Fix mobile */
      -webkit-overflow-scrolling: touch;
    }
    
    .pannello-evento-gestione.active {
      display: flex;
      display: -webkit-flex;
    }
    
    .pannello-evento-content {
      background: #fff;
      border: 3px solid #c89858;
      border-radius: 12px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(107, 68, 35, 0.3);
    }
    
    .pannello-evento-header {
      background: linear-gradient(135deg, #e8b873 0%, #c89858 100%);
      padding: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 10px 10px 0 0;
    }
    
    .pannello-evento-titolo h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.7em;
      color: #fff;
      margin: 0 0 6px 0;
      font-weight: 700;
    }
    
    .pannello-evento-titolo p {
      color: rgba(255,255,255,0.95);
      font-size: 1em;
      margin: 0;
      font-weight: 500;
    }
    
    .btn-chiudi-pannello {
      background: rgba(255,255,255,0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: #fff;
      padding: 10px 20px;
      border: 2px solid rgba(255,255,255,0.4);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      font-size: 0.95em;
      transition: all 0.2s;
    }
    
    .btn-chiudi-pannello:hover {
      background: rgba(255,255,255,0.35);
      transform: translateY(-1px);
    }
    
    .btn-modifica-evento {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: #fff;
      border: 2px solid rgba(255,255,255,0.35);
      padding: 9px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .btn-modifica-evento:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-1px);
    }
    
    .pannello-evento-body {
      padding: 25px;
    }
    
    .contatore-evento-grande {
      background: linear-gradient(135deg, #e8b873 0%, #c89858 100%);
      border-radius: 12px;
      padding: 28px;
      margin-bottom: 25px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(200, 152, 88, 0.25);
    }
    
    .contatore-evento-numero {
      font-family: 'Playfair Display', serif;
      font-size: 3.5em;
      color: #fff;
      font-weight: 700;
      line-height: 1;
    }
    
    .contatore-evento-label {
      font-size: 1.15em;
      color: rgba(255,255,255,0.95);
      margin-top: 8px;
      font-weight: 600;
    }
    
    .prenotazioni-evento-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
    }
    
    .prenotazioni-evento-header h3 {
      font-family: 'Playfair Display', serif;
      font-size: 1.3em;
      color: #6b4423;
      margin: 0;
      font-weight: 700;
    }
    
    /* CARD PRENOTAZIONE EVENTO */
    .prenotazione-evento-card {
      background: #faf5ef;
      border: 2px solid #e8dcc8;
      border-radius: 10px;
      padding: 18px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }
    
    .prenotazione-evento-card:hover {
      border-color: #c89858;
      box-shadow: 0 3px 10px rgba(200, 152, 88, 0.15);
      transform: translateX(3px);
    }
    
    .prenotazione-evento-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .prenotazione-evento-cliente {
      font-size: 1.2em;
      font-weight: 700;
      color: #2c1810;
    }
    
    .prenotazione-evento-persone {
      background: linear-gradient(135deg, #e8b873 0%, #c89858 100%);
      color: #fff;
      padding: 7px 14px;
      border-radius: 18px;
      font-weight: 700;
      font-size: 1em;
      box-shadow: 0 3px 10px rgba(200, 152, 88, 0.25);
    }
    
    .prenotazione-evento-dettagli {
      color: #6b4423;
      font-size: 0.95em;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .prenotazione-evento-dettagli span {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .prenotazione-evento-note {
      background: #fff;
      border-left: 3px solid #c89858;
      padding: 10px 14px;
      margin: 8px 0;
      color: #6b4423;
      font-size: 0.9em;
      border-radius: 5px;
    }
    
    /* CARD EVENTO */
    .card-evento {
      background: linear-gradient(135deg, #fff9f0 0%, #ffedd5 100%);
      border: 3px solid #e8b873;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    
    .card-evento::before {
      content: 'üç∑';
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 2.2em;
      opacity: 0.12;
    }
    
    .card-evento:hover {
      transform: translateX(3px);
      box-shadow: 0 5px 18px rgba(232, 184, 115, 0.25);
      border-color: #c89858;
    }
    
    .evento-nome {
      font-family: 'Playfair Display', serif;
      font-size: 1.25em;
      font-weight: 700;
      color: #8b4513;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .evento-descrizione {
      font-size: 0.95em;
      color: #6b4423;
      margin-bottom: 10px;
      line-height: 1.4;
    }
    
    .evento-contatore {
      display: inline-block;
      background: linear-gradient(135deg, #e8b873 0%, #c89858 100%);
      color: #fff;
      padding: 5px 12px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 0.9em;
      box-shadow: 0 3px 8px rgba(200, 152, 88, 0.25);
    }
    
    /* FEEDBACK OTTIMISTICO */
    .prenotazione-item.deleting {
      opacity: 0.5;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="header-container">
    <div class="header">
      <div class="header-title">
        <span class="header-anchor">‚öì</span>
        <h1>Prenotazioni</h1>
      </div>
      <a href="index.html" class="btn-back" title="Torna indietro">
        ‚Ü∂
      </a>
    </div>
  </div>
  
  <div class="container">
    <div class="calendario-container">
    <!-- CALENDARIO -->
    <div class="calendario">
      <div class="calendario-header">
        <h2 id="meseAnno"></h2>
        <div class="calendario-nav">
          <button class="btn-nav" onclick="cambiaMese(-1)">‚óÄ</button>
          <button class="btn-nav" onclick="cambiaMese(0)">Oggi</button>
          <button class="btn-nav" onclick="cambiaMese(1)">‚ñ∂</button>
        </div>
      </div>
      
      <div class="giorni-settimana">
        <div class="giorno-settimana">Lun</div>
        <div class="giorno-settimana">Mar</div>
        <div class="giorno-settimana">Mer</div>
        <div class="giorno-settimana">Gio</div>
        <div class="giorno-settimana">Ven</div>
        <div class="giorno-settimana">Sab</div>
        <div class="giorno-settimana">Dom</div>
      </div>
      
      <div class="giorni-container" id="giorniContainer"></div>
    </div>
    
    <!-- PANNELLO LATERALE -->
    <div class="pannello-laterale">
      <div class="pannello-header">
        <h3 id="pannelloTitolo">Seleziona un giorno</h3>
        <button class="btn-nuova" onclick="nuovaPrenotazione()" title="Nuova prenotazione">+</button>
      </div>
      <div id="prenotazioniContainer">
        <div style="text-align:center;padding:60px 20px;">
          <div style="font-size:4em;margin-bottom:15px;">üìÜ</div>
          <p style="color:#f4e4c1;font-size:1.1em;line-height:1.6;">Clicca su un giorno per vedere le prenotazioni</p>
        </div>
      </div>
    </div>
    </div>
  </div>
  
  <!-- LOADING OVERLAY -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-container">
      <div class="spinner"></div>
      <div class="loading-text" id="loadingText">Caricamento...</div>
    </div>
  </div>
  
  <!-- MODAL FORM -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitolo">üìù Nuova Prenotazione</div>
      
      <!-- Toggle tipo prenotazione/evento -->
      <div class="toggle-tipo" id="toggleTipo">
        <button class="toggle-btn active" id="btnTipoPrenotazione" onclick="switchToPrenotazione()">üìù Prenotazione</button>
        <button class="toggle-btn" id="btnTipoEvento" onclick="switchToEvento()">üç∑ Evento</button>
      </div>
      
      <!-- Form Prenotazione -->
      <form id="formPrenotazione" style="display:block;">
        <div class="form-group">
          <label>üìÖ Data</label>
          <input type="date" id="dataPrenotazione" required>
        </div>
        <div class="form-group">
          <label>üïê Ora</label>
          <input type="time" id="oraPrenotazione" required>
        </div>
        <div class="form-group">
          <label>üë§ Cliente</label>
          <input type="text" id="clientePrenotazione" required>
        </div>
        <div class="form-group">
          <label>üìû Telefono</label>
          <input type="tel" id="telefonoPrenotazione" required>
        </div>
        <div class="form-group">
          <label>üë• Persone</label>
          <input type="number" id="personePrenotazione" min="1" required>
        </div>
        <div class="form-group">
          <label>üìã Note</label>
          <textarea id="notePrenotazione"></textarea>
        </div>
        <div class="form-group">
          <label>‚úÖ Stato</label>
          <select id="statoPrenotazione">
            <option value="confermato">Confermato</option>
            <option value="attesa">In Attesa</option>
            <option value="cancellato">Cancellato</option>
          </select>
        </div>
        <input type="hidden" id="eventoIdPrenotazione">
        <div class="form-actions">
          <button type="submit" class="btn-submit">Salva</button>
          <button type="button" class="btn-cancel" onclick="chiudiModal()">Annulla</button>
        </div>
      </form>
      
      <!-- Form Evento -->
      <form id="formEvento" style="display:none;">
        <div class="form-group">
          <label>üç∑ Nome Evento</label>
          <input type="text" id="nomeEvento" required>
        </div>
        <div class="form-group">
          <label>üìÖ Data</label>
          <input type="date" id="dataEvento" required>
        </div>
        <div class="form-group">
          <label>üìã Descrizione</label>
          <textarea id="descrizioneEvento"></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn-submit">Crea Evento</button>
          <button type="button" class="btn-cancel" onclick="chiudiModal()">Annulla</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- PANNELLO GESTIONE EVENTO -->
  <div class="pannello-evento-gestione" id="pannelloEvento">
    <div class="pannello-evento-content">
      <div class="pannello-evento-header">
        <div class="pannello-evento-titolo">
          <h2 id="eventoNomeTitolo"></h2>
          <p id="eventoDataTitolo"></p>
        </div>
        <div style="display:flex; gap:10px;">
          <button class="btn-modifica-evento" onclick="modificaEventoCorrente()">‚úèÔ∏è Modifica</button>
          <button class="btn-chiudi-pannello" onclick="chiudiPannelloEvento()">‚Üê Torna</button>
        </div>
      </div>
      <div class="pannello-evento-body">
        <div class="contatore-evento-grande">
          <div class="contatore-evento-numero" id="contatorePersone">0</div>
          <div class="contatore-evento-label">üë• Persone Confermate</div>
        </div>
        
        <div class="prenotazioni-evento-header">
          <h3>üìã Prenotazioni Evento</h3>
          <button class="btn-nuova" onclick="aggiungiPrenotazioneEvento()" title="Aggiungi prenotazione">+</button>
        </div>
        <div id="prenotazioniEventoContainer"></div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzcpybXvlL5Ge24NztvVL3Kz8Jhd3jRHWH0KZmZgKW9577DIqsvXUH7h2lN4ZkzldHisQ/exec';
    
    let prenotazioni = [];
    let eventi = [];
    let annoCorrente = new Date().getFullYear();
    let meseCorrente = new Date().getMonth();
    let giornoSelezionato = null;
    let prenotazioneInModifica = null;
    let eventoInModifica = null;
    let eventoCorrente = null;
    
    // ===== SISTEMA CACHE LOCALSTORAGE =====
    const CACHE_TTL = 5 * 60 * 1000; // 5 minuti
    const CACHE_PREFIX = 'vdc_';
    
    function getCacheKey(action, params = {}) {
      const sortedParams = Object.keys(params).sort().reduce((acc, key) => {
        acc[key] = params[key];
        return acc;
      }, {});
      return `${CACHE_PREFIX}${action}_${JSON.stringify(sortedParams)}`;
    }
    
    function getCache(key) {
      try {
        const cached = localStorage.getItem(key);
        if (!cached) return null;
        
        const {data, timestamp} = JSON.parse(cached);
        const age = Date.now() - timestamp;
        
        if (age > CACHE_TTL) {
          localStorage.removeItem(key);
          return null;
        }
        
        console.log(`üì¶ Cache HIT (age: ${Math.round(age/1000)}s): ${key.replace(CACHE_PREFIX, '')}`);
        return data;
      } catch (e) {
        console.error('Cache read error:', e);
        return null;
      }
    }
    
    function setCache(key, data) {
      try {
        const payload = {
          data,
          timestamp: Date.now()
        };
        localStorage.setItem(key, JSON.stringify(payload));
        console.log(`üíæ Cache SET: ${key.replace(CACHE_PREFIX, '')}`);
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          console.warn('Cache full, clearing old entries...');
          clearOldCache();
          try {
            localStorage.setItem(key, JSON.stringify({data, timestamp: Date.now()}));
          } catch (e2) {
            console.error('Cache still full after cleanup:', e2);
          }
        } else {
          console.error('Cache write error:', e);
        }
      }
    }
    
    function clearOldCache() {
      try {
        const keys = Object.keys(localStorage).filter(k => k.startsWith(CACHE_PREFIX));
        const entries = keys.map(k => {
          try {
            const data = JSON.parse(localStorage.getItem(k));
            return {key: k, timestamp: data.timestamp || 0};
          } catch {
            return {key: k, timestamp: 0};
          }
        }).sort((a, b) => a.timestamp - b.timestamp);
        
        const toRemove = Math.ceil(entries.length * 0.3);
        for (let i = 0; i < toRemove; i++) {
          localStorage.removeItem(entries[i].key);
        }
        console.log(`üßπ Cleared ${toRemove} old cache entries`);
      } catch (e) {
        console.error('Cache cleanup error:', e);
      }
    }
    
    function invalidateCache(pattern = null) {
      try {
        const keys = Object.keys(localStorage).filter(k => {
          if (!k.startsWith(CACHE_PREFIX)) return false;
          if (!pattern) return true;
          return k.includes(pattern);
        });
        
        keys.forEach(k => localStorage.removeItem(k));
        if (keys.length > 0) {
          console.log(`üóëÔ∏è Invalidated ${keys.length} cache entries${pattern ? ` (${pattern})` : ''}`);
        }
      } catch (e) {
        console.error('Cache invalidation error:', e);
      }
    }
    
    async function callAPI(action, data = {}) {
      const isReadAction = action === 'getPrenotazioni' || action === 'getEventi';
      
      if (isReadAction) {
        const cacheKey = getCacheKey(action, data);
        const cached = getCache(cacheKey);
        
        if (cached) {
          return cached;
        }
        
        console.log(`üåê Cache MISS: ${action} - API call`);
      }
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          mode: 'cors',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: new URLSearchParams({azione: action, ...data})
        });
        
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const result = await response.json();
        
        if (isReadAction && !result.errore) {
          const cacheKey = getCacheKey(action, data);
          setCache(cacheKey, result);
        }
        
        const writeActions = {
          'salvaPrenotazione': 'getPrenotazioni',
          'modificaPrenotazione': 'getPrenotazioni',
          'eliminaPrenotazione': 'getPrenotazioni',
          'creaEvento': 'getEventi',
          'modificaEvento': 'getEventi',
          'eliminaEvento': 'getEventi'
        };
        
        if (writeActions[action]) {
          invalidateCache(writeActions[action]);
        }
        
        return result;
      } catch (error) {
        console.error('API error:', error);
        
        if (isReadAction) {
          const cacheKey = getCacheKey(action, data);
          const staleCache = localStorage.getItem(cacheKey);
          if (staleCache) {
            console.warn('‚ö†Ô∏è Using stale cache due to API error');
            try {
              return JSON.parse(staleCache).data;
            } catch {}
          }
        }
        
        return {errore: error.message};
      }
    }
    
    function showLoading(text = 'Caricamento...') {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').classList.add('active');
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }
    
    async function caricaPrenotazioni() {
      showLoading('Caricamento prenotazioni...');
      try {
        const [resultPren, resultEventi] = await Promise.all([
          callAPI('getPrenotazioni', {
            anno: annoCorrente,
            mese: meseCorrente + 1
          }),
          callAPI('getEventi')
        ]);
        
        if (resultPren.prenotazioni) {
          prenotazioni = resultPren.prenotazioni;
        } else if (resultPren.errore) {
          console.error('Errore API prenotazioni:', resultPren.errore);
          prenotazioni = [];
        }
        
        if (resultEventi.eventi) {
          eventi = resultEventi.eventi;
        } else if (resultEventi.errore) {
          console.error('Errore API eventi:', resultEventi.errore);
          eventi = [];
        }
      } catch (error) {
        console.error('Errore caricamento:', error);
        prenotazioni = [];
        eventi = [];
      }
      
      generaCalendario();
      
      if (giornoSelezionato) {
        mostraPrenotazioniGiorno(giornoSelezionato);
      }
      
      hideLoading();
    }
    
    function selezionaGiorno(dataStr) {
      giornoSelezionato = dataStr;
      generaCalendario();
      mostraPrenotazioniGiorno(dataStr);
    }
    
    function mostraPrenotazioniGiorno(dataStr) {
      const prenotazioniNormali = prenotazioni.filter(p => p.data === dataStr && !p.evento_id);
      const eventiGiorno = eventi.filter(e => e.data === dataStr);
      
      const [anno, mese, giorno] = dataStr.split('-');
      const data = new Date(anno, mese - 1, giorno);
      const nomeGiorno = data.toLocaleDateString('it-IT', {weekday: 'long', day: 'numeric', month: 'long'});
      
      document.getElementById('pannelloTitolo').textContent = nomeGiorno.charAt(0).toUpperCase() + nomeGiorno.slice(1);
      
      let html = '';
      
      eventiGiorno.forEach(evento => {
        const numPersone = prenotazioni.filter(p => p.evento_id === evento.id).reduce((sum, p) => sum + parseInt(p.persone || 0), 0);
        html += `
          <div class="card-evento" onclick="apriGestioneEvento('${evento.id}')">
            <div class="evento-nome">üç∑ ${evento.nome}</div>
            ${evento.descrizione ? `<div class="evento-descrizione">${evento.descrizione}</div>` : ''}
            <div class="evento-contatore">${numPersone} üë• confermati</div>
          </div>
        `;
      });
      
      prenotazioniNormali.forEach(p => {
        const iconaStato = p.stato === 'confermato' ? '‚úÖ' : p.stato === 'attesa' ? '‚è≥' : '‚ùå';
        html += `
          <div class="prenotazione-card">
            <div class="prenotazione-ora">üïê ${p.ora}</div>
            <div class="prenotazione-cliente">üë§ ${p.cliente}</div>
            <div class="prenotazione-dettagli">üìû ${p.telefono} ‚Ä¢ üë• ${p.persone} persone ‚Ä¢ ${iconaStato} ${p.stato}</div>
            ${p.note ? `<div class="prenotazione-note">üìã ${p.note}</div>` : ''}
            <div class="prenotazione-actions">
              <button class="btn-modifica" onclick="modificaPrenotazione('${p.id}')">‚úèÔ∏è Modifica</button>
              <button class="btn-elimina" onclick="confermaElimina('${p.id}')">üóëÔ∏è Elimina</button>
            </div>
          </div>
        `;
      });
      
      if (!html) {
        html = '<div style="text-align:center;padding:50px 20px;"><div style="font-size:3.5em;margin-bottom:12px;">üèùÔ∏è</div><p style="color:#f4e4c1;font-size:1.05em;opacity:0.9;">Nessuna prenotazione o evento per questo giorno</p></div>';
      }
      
      document.getElementById('prenotazioniContainer').innerHTML = html;
    }
    
    function generaCalendario() {
      const container = document.getElementById('giorniContainer');
      const primoGiorno = new Date(annoCorrente, meseCorrente, 1);
      const ultimoGiorno = new Date(annoCorrente, meseCorrente + 1, 0);
      const giorniMese = ultimoGiorno.getDate();
      const primoGiornoSettimana = (primoGiorno.getDay() + 6) % 7;
      
      const nomiMesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
      document.getElementById('meseAnno').textContent = `${nomiMesi[meseCorrente]} ${annoCorrente}`;
      
      container.innerHTML = '';
      
      const mesePrec = meseCorrente === 0 ? 11 : meseCorrente - 1;
      const annoPrec = meseCorrente === 0 ? annoCorrente - 1 : annoCorrente;
      const giorniMesePrec = new Date(annoPrec, mesePrec + 1, 0).getDate();
      
      for (let i = primoGiornoSettimana - 1; i >= 0; i--) {
        const giorno = giorniMesePrec - i;
        container.innerHTML += `<div class="giorno altro-mese"><div class="giorno-numero">${giorno}</div></div>`;
      }
      
      const oggi = new Date();
      const dataOggi = oggi.toISOString().split('T')[0];
      
      for (let giorno = 1; giorno <= giorniMese; giorno++) {
        const dataStr = `${annoCorrente}-${String(meseCorrente + 1).padStart(2, '0')}-${String(giorno).padStart(2, '0')}`;
        const dataObj = new Date(annoCorrente, meseCorrente, giorno);
        const isDomenica = dataObj.getDay() === 0;
        
        const numPrenotazioni = prenotazioni.filter(p => p.data === dataStr && !p.evento_id).length;
        const hasEvento = eventi.some(e => e.data === dataStr);
        
        const isOggi = dataStr === dataOggi;
        const isSelezionato = dataStr === giornoSelezionato;
        
        let classi = 'giorno';
        if (isOggi) classi += ' oggi';
        if (isSelezionato) classi += ' selezionato';
        if (isDomenica) classi += ' domenica';
        
        let badgeTipo = '';
        if (hasEvento && numPrenotazioni > 0) {
          badgeTipo = '<div class="giorno-tipo-badge"><span class="badge-prenotazione">‚öì</span><span class="badge-evento">üç∑</span></div>';
        } else if (hasEvento) {
          badgeTipo = '<div class="giorno-tipo-badge"><span class="badge-evento">üç∑</span></div>';
        } else if (numPrenotazioni > 0) {
          badgeTipo = '<div class="giorno-tipo-badge"><span class="badge-prenotazione">‚öì</span></div>';
        }
        
        const totaleGiorno = numPrenotazioni + (hasEvento ? 1 : 0);
        const badgeNumero = totaleGiorno > 0 ? `<div class="giorno-badge">${totaleGiorno}</div>` : '';
        
        container.innerHTML += `
          <div class="${classi}" onclick="selezionaGiorno('${dataStr}')">
            <div class="giorno-numero">${giorno}</div>
            ${badgeNumero}
            ${badgeTipo}
          </div>
        `;
      }
      
      const giorniRestanti = 42 - (primoGiornoSettimana + giorniMese);
      for (let i = 1; i <= giorniRestanti; i++) {
        container.innerHTML += `<div class="giorno altro-mese"><div class="giorno-numero">${i}</div></div>`;
      }
    }
    
    function cambiaMese(delta) {
      if (delta === 0) {
        annoCorrente = new Date().getFullYear();
        meseCorrente = new Date().getMonth();
        giornoSelezionato = new Date().toISOString().split('T')[0];
      } else {
        meseCorrente += delta;
        if (meseCorrente > 11) {
          meseCorrente = 0;
          annoCorrente++;
        } else if (meseCorrente < 0) {
          meseCorrente = 11;
          annoCorrente--;
        }
      }
      caricaPrenotazioni();
    }
    
    function nuovaPrenotazione() {
      prenotazioneInModifica = null;
      eventoInModifica = null;
      
      document.getElementById('modalTitolo').textContent = 'üìù Nuova Prenotazione';
      document.getElementById('toggleTipo').style.display = 'flex';
      switchToPrenotazione();
      
      document.getElementById('formPrenotazione').reset();
      document.getElementById('formEvento').reset();
      document.getElementById('dataPrenotazione').value = giornoSelezionato || '';
      document.getElementById('eventoIdPrenotazione').value = '';
      
      document.getElementById('modal').classList.add('active');
    }
    
    function switchToPrenotazione() {
      document.getElementById('btnTipoPrenotazione').classList.add('active');
      document.getElementById('btnTipoEvento').classList.remove('active');
      document.getElementById('formPrenotazione').style.display = 'block';
      document.getElementById('formEvento').style.display = 'none';
    }
    
    function switchToEvento() {
      document.getElementById('btnTipoPrenotazione').classList.remove('active');
      document.getElementById('btnTipoEvento').classList.add('active');
      document.getElementById('formPrenotazione').style.display = 'none';
      document.getElementById('formEvento').style.display = 'block';
      
      if (!eventoInModifica) {
        document.getElementById('modalTitolo').textContent = 'üç∑ Nuovo Evento';
        document.getElementById('dataEvento').value = giornoSelezionato || '';
      }
    }
    
    function chiudiModal() {
      document.getElementById('modal').classList.remove('active');
      prenotazioneInModifica = null;
      eventoInModifica = null;
    }
    
    document.getElementById('formPrenotazione').addEventListener('submit', async (e) => {
      e.preventDefault();
      showLoading('Salvataggio...');
      
      const data = {
        id: prenotazioneInModifica?.id || '',
        data: document.getElementById('dataPrenotazione').value,
        ora: document.getElementById('oraPrenotazione').value,
        cliente: document.getElementById('clientePrenotazione').value,
        telefono: document.getElementById('telefonoPrenotazione').value,
        persone: document.getElementById('personePrenotazione').value,
        note: document.getElementById('notePrenotazione').value,
        stato: document.getElementById('statoPrenotazione').value,
        evento_id: document.getElementById('eventoIdPrenotazione').value
      };
      
      const action = prenotazioneInModifica ? 'modificaPrenotazione' : 'salvaPrenotazione';
      const result = await callAPI(action, data);
      
      hideLoading();
      
      if (result.successo) {
        chiudiModal();
        await caricaPrenotazioni();
        
        if (eventoCorrente) {
          apriGestioneEvento(eventoCorrente.id);
        } else if (giornoSelezionato) {
          mostraPrenotazioniGiorno(giornoSelezionato);
        }
      } else {
        alert('Errore: ' + (result.errore || 'Impossibile salvare'));
      }
    });
    
    document.getElementById('formEvento').addEventListener('submit', async (e) => {
      e.preventDefault();
      showLoading('Salvataggio evento...');
      
      const data = {
        id: eventoInModifica?.id || '',
        nome: document.getElementById('nomeEvento').value,
        data: document.getElementById('dataEvento').value,
        descrizione: document.getElementById('descrizioneEvento').value
      };
      
      const action = eventoInModifica ? 'modificaEvento' : 'creaEvento';
      const result = await callAPI(action, data);
      
      hideLoading();
      
      if (result.successo) {
        chiudiModal();
        await caricaPrenotazioni();
        
        if (eventoInModifica) {
          apriGestioneEvento(eventoInModifica.id);
        } else if (giornoSelezionato) {
          mostraPrenotazioniGiorno(giornoSelezionato);
        }
      } else {
        alert('Errore: ' + (result.errore || 'Impossibile salvare evento'));
      }
    });
    
    async function modificaPrenotazione(id) {
      const pren = prenotazioni.find(p => p.id === id);
      if (!pren) return;
      
      prenotazioneInModifica = pren;
      
      document.getElementById('modalTitolo').textContent = '‚úèÔ∏è Modifica Prenotazione';
      document.getElementById('toggleTipo').style.display = 'none';
      switchToPrenotazione();
      
      document.getElementById('dataPrenotazione').value = pren.data;
      document.getElementById('oraPrenotazione').value = pren.ora;
      document.getElementById('clientePrenotazione').value = pren.cliente;
      document.getElementById('telefonoPrenotazione').value = pren.telefono;
      document.getElementById('personePrenotazione').value = pren.persone;
      document.getElementById('notePrenotazione').value = pren.note || '';
      document.getElementById('statoPrenotazione').value = pren.stato;
      document.getElementById('eventoIdPrenotazione').value = pren.evento_id || '';
      
      document.getElementById('modal').classList.add('active');
    }
    
    async function confermaElimina(id) {
      if (!confirm('Sei sicuro di voler eliminare questa prenotazione?')) return;
      
      showLoading('Eliminazione...');
      const result = await callAPI('eliminaPrenotazione', {id});
      hideLoading();
      
      if (result.successo) {
        await caricaPrenotazioni();
        
        if (eventoCorrente) {
          apriGestioneEvento(eventoCorrente.id);
        } else if (giornoSelezionato) {
          mostraPrenotazioniGiorno(giornoSelezionato);
        }
      } else {
        alert('Errore: ' + (result.errore || 'Impossibile eliminare'));
      }
    }
    
    function apriGestioneEvento(eventoId) {
      const evento = eventi.find(e => e.id === eventoId);
      if (!evento) return;
      
      eventoCorrente = evento;
      
      document.getElementById('eventoNomeTitolo').textContent = 'üç∑ ' + evento.nome;
      document.getElementById('eventoDataTitolo').textContent = new Date(evento.data + 'T12:00:00').toLocaleDateString('it-IT', {weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'});
      
      const prenotazioniEvento = prenotazioni.filter(p => p.evento_id === eventoId);
      const totalePersone = prenotazioniEvento.reduce((sum, p) => sum + parseInt(p.persone || 0), 0);
      
      document.getElementById('contatorePersone').textContent = totalePersone;
      
      let html = '';
      prenotazioniEvento.forEach(p => {
        const iconaStato = p.stato === 'confermato' ? '‚úÖ' : p.stato === 'attesa' ? '‚è≥' : '‚ùå';
        html += `
          <div class="prenotazione-evento-card">
            <div class="prenotazione-evento-top">
              <div class="prenotazione-evento-cliente">üë§ ${p.cliente}</div>
              <div class="prenotazione-evento-persone">${p.persone} üë•</div>
            </div>
            <div class="prenotazione-evento-dettagli">
              <span>üïê ${p.ora}</span>
              <span>üìû ${p.telefono}</span>
              <span>${iconaStato} ${p.stato}</span>
            </div>
            ${p.note ? `<div class="prenotazione-evento-note">üìã ${p.note}</div>` : ''}
            <div class="prenotazione-actions">
              <button class="btn-modifica" onclick="modificaPrenotazione('${p.id}')">‚úèÔ∏è Modifica</button>
              <button class="btn-elimina" onclick="confermaElimina('${p.id}')">üóëÔ∏è Elimina</button>
            </div>
          </div>
        `;
      });
      
      if (!html) {
        html = '<div style="text-align:center;padding:50px 20px;"><div style="font-size:3.5em;margin-bottom:12px;">üèùÔ∏è</div><p style="color:#f4e4c1;font-size:1.05em;opacity:0.9;">Nessuna prenotazione per questo evento</p></div>';
      }
      
      document.getElementById('prenotazioniEventoContainer').innerHTML = html;
      document.getElementById('pannelloEvento').classList.add('active');
    }
    
    function chiudiPannelloEvento() {
      document.getElementById('pannelloEvento').classList.remove('active');
      eventoCorrente = null;
      
      if (giornoSelezionato) {
        mostraPrenotazioniGiorno(giornoSelezionato);
      }
    }
    
    function aggiungiPrenotazioneEvento() {
      if (!eventoCorrente) return;
      
      prenotazioneInModifica = null;
      
      document.getElementById('modalTitolo').textContent = 'üç∑ Nuova Prenotazione Evento';
      document.getElementById('toggleTipo').style.display = 'none';
      switchToPrenotazione();
      
      document.getElementById('formPrenotazione').reset();
      document.getElementById('dataPrenotazione').value = eventoCorrente.data;
      document.getElementById('eventoIdPrenotazione').value = eventoCorrente.id;
      
      document.getElementById('modal').classList.add('active');
    }
    
    function modificaEventoCorrente() {
      if (!eventoCorrente) return;
      
      eventoInModifica = eventoCorrente;
      
      document.getElementById('modalTitolo').textContent = '‚úèÔ∏è Modifica Evento';
      document.getElementById('toggleTipo').style.display = 'none';
      switchToEvento();
      
      document.getElementById('nomeEvento').value = eventoCorrente.nome;
      document.getElementById('dataEvento').value = eventoCorrente.data;
      document.getElementById('descrizioneEvento').value = eventoCorrente.descrizione || '';
      
      document.getElementById('modal').classList.add('active');
    }
    
    // Init
    caricaPrenotazioni();
    
    // Refresh cache ogni 30 secondi
    setInterval(() => {
      if (document.visibilityState === 'visible') {
        console.log('üîÑ Auto-refresh cache');
        invalidateCache('getPrenotazioni');
        invalidateCache('getEventi');
      }
    }, 30000);
    
    // PWA Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(err => console.log('SW:', err));
    }
  </script>
</body>
</html>
